<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>../drake/externals/libbot/bot2-vis/src/bot_vis/viewer.c</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl ppc">#include &lt;stdio.h&gt;</span>
<span class="hl ppc">#include &lt;stdlib.h&gt;</span>
<span class="hl ppc">#include &lt;stdarg.h&gt;</span>
<span class="hl ppc">#include &lt;time.h&gt;</span>
<span class="hl ppc">#include &lt;math.h&gt;</span>
<span class="hl ppc">#include &lt;assert.h&gt;</span>
<span class="hl ppc">#include &lt;string.h&gt;</span>

<span class="hl ppc">#include &lt;zlib.h&gt;</span>

<span class="hl ppc">#ifdef __APPLE__</span>
<span class="hl ppc">#include &lt;OpenGL/gl.h&gt;</span>
<span class="hl ppc">#include &lt;OpenGL/glu.h&gt;</span>
<span class="hl ppc">#include &lt;GLUT/glut.h&gt;</span>
<span class="hl ppc">#else</span>
<span class="hl ppc">#include &lt;GL/gl.h&gt;</span>
<span class="hl ppc">#include &lt;GL/glu.h&gt;</span>
<span class="hl ppc">#include &lt;GL/glut.h&gt;</span>
<span class="hl ppc">#endif</span>

<span class="hl ppc">#include &lt;gtk/gtk.h&gt;</span>
<span class="hl ppc">#include &lt;gdk/gdkkeysyms.h&gt;</span>

<span class="hl ppc">#include &lt;bot_core/bot_core.h&gt;</span>

<span class="hl ppc">#include</span> <span class="hl pps">&quot;gtk_util.h&quot;</span><span class="hl ppc"></span>
<span class="hl ppc">#include</span> <span class="hl pps">&quot;viewer.h&quot;</span><span class="hl ppc"></span>
<span class="hl ppc">#include</span> <span class="hl pps">&quot;default_view_handler.h&quot;</span><span class="hl ppc"></span>

<span class="hl slc">//#define dbg(args...) fprintf (stderr, args)</span>
<span class="hl ppc">#define dbg(args...) </span>
<span class="hl ppc">#define err(args...) fprintf (stderr, args)</span>

<span class="hl ppc">#define TYPE_BOT_VIEWER  bot_viewer_get_type()</span>
<span class="hl ppc">#define BOT_VIEWER_BOT_VIEWER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), \</span>
<span class="hl ppc">            TYPE_BOT_VIEWER, BotBotViewerClass ))</span>
<span class="hl ppc">#define IS_BOT_VIEWER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), TYPE_BOT_VIEWER))</span>
<span class="hl ppc">#define IS_BOT_VIEWER_CLASS(klass)   (G_TYPE_CHECK_CLASS_TYPE((klass), TYPE_BOT_VIEWER))</span>

<span class="hl ppc">#define MAX_REDRAW_HZ 30</span>

<span class="hl kwb">static int</span> g_draws <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>


<span class="hl slc">// a structure for bookmarked viewpoints</span>
<span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> _bookmark_persp bookmark_persp_t<span class="hl opt">;</span>
<span class="hl kwb">struct</span> _bookmark_persp <span class="hl opt">{</span>
    BotViewer<span class="hl opt">*</span> viewer<span class="hl opt">;</span>
    <span class="hl kwb">double</span> eye<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwb">double</span> lookat<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwb">double</span> up<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    BotProjectionMode projection_mode<span class="hl opt">;</span>
    <span class="hl kwb">int</span> saved<span class="hl opt">;</span>
    <span class="hl kwb">int</span> index<span class="hl opt">;</span>
<span class="hl opt">}</span> bmtemp<span class="hl opt">;</span>

<span class="hl kwb">enum</span> <span class="hl opt">{</span>
    LOAD_PREFERENCES_SIGNAL<span class="hl opt">,</span>
    SAVE_PREFERENCES_SIGNAL<span class="hl opt">,</span>
    RENDER_BEGIN_SIGNAL<span class="hl opt">,</span>
    RENDER_END_SIGNAL<span class="hl opt">,</span>
    LAST_SIGNAL
<span class="hl opt">};</span>

<span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> _BotViewerPriv BotViewerPriv<span class="hl opt">;</span>
<span class="hl kwb">struct</span> _BotViewerPriv <span class="hl opt">{</span>
    <span class="hl com">/*&lt; private &gt;*/</span>
    <span class="hl kwb">int64_t</span> next_render_utime<span class="hl opt">;</span>
    <span class="hl kwb">int64_t</span> render_interval_usec<span class="hl opt">;</span>

    bookmark_persp_t<span class="hl opt">*</span> bookmarks<span class="hl opt">;</span>
    <span class="hl kwb">int</span> num_bookmarks<span class="hl opt">;</span>

    GtkAccelGroup<span class="hl opt">*</span> key_accel_group<span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl ppc">#define BOT_VIEWER_GET_PRIVATE(o) (G_TYPE_INSTANCE_GET_PRIVATE((o), TYPE_BOT_VIEWER, BotViewerPriv))</span>

<span class="hl kwb">static</span> guint bot_viewer_signals<span class="hl opt">[</span>LAST_SIGNAL<span class="hl opt">] = {</span> <span class="hl num">0</span> <span class="hl opt">};</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_request_redraw</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>self<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwd">bot_gtk_gl_drawing_area_invalidate</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean
<span class="hl kwd">on_render_timer</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span> self<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewerPriv <span class="hl opt">*</span>priv <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER_GET_PRIVATE</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl slc">// this timer is called more often than we actually want to render.  </span>
    <span class="hl slc">// check if we want to render.</span>
    <span class="hl kwb">int64_t</span> now <span class="hl opt">=</span> <span class="hl kwd">bot_timestamp_now</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span><span class="hl opt">(</span>priv<span class="hl opt">-&gt;</span>next_render_utime <span class="hl opt">&lt;</span> now<span class="hl opt">) {</span>
        self<span class="hl opt">-&gt;</span>movie_draw_pending <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl kwd">bot_viewer_request_redraw</span><span class="hl opt">(</span>self<span class="hl opt">);</span>

        <span class="hl kwa">while</span><span class="hl opt">(</span>priv<span class="hl opt">-&gt;</span>next_render_utime <span class="hl opt">&lt;</span> now<span class="hl opt">)</span> 
            priv<span class="hl opt">-&gt;</span>next_render_utime <span class="hl opt">+=</span> priv<span class="hl opt">-&gt;</span>render_interval_usec<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> 
<span class="hl kwd">bot_viewer_start_recording</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>self<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>is_recording<span class="hl opt">) {</span>
        <span class="hl kwd">err</span> <span class="hl opt">(</span><span class="hl str">&quot;viewer: already recording!!</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">assert</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_buffer <span class="hl opt">==</span> NULL<span class="hl opt">);</span>

    <span class="hl kwb">int</span> window_width <span class="hl opt">=</span> <span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">)-&gt;</span>allocation<span class="hl opt">.</span>width<span class="hl opt">;</span>
    <span class="hl kwb">int</span> window_height <span class="hl opt">=</span> <span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">)-&gt;</span>allocation<span class="hl opt">.</span>height<span class="hl opt">;</span>

    self<span class="hl opt">-&gt;</span>movie_width <span class="hl opt">=</span> window_width <span class="hl opt">- (</span>window_width <span class="hl opt">%</span> <span class="hl num">4</span><span class="hl opt">);</span>
    self<span class="hl opt">-&gt;</span>movie_height <span class="hl opt">=</span> window_height<span class="hl opt">;</span>
    self<span class="hl opt">-&gt;</span>movie_stride <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>movie_width <span class="hl opt">*</span> <span class="hl num">3</span><span class="hl opt">;</span>
    self<span class="hl opt">-&gt;</span>movie_buffer <span class="hl opt">= (</span><span class="hl kwb">uint8_t</span><span class="hl opt">*)</span> <span class="hl kwd">malloc</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_stride <span class="hl opt">*</span> self<span class="hl opt">-&gt;</span>movie_height<span class="hl opt">);</span>
    self<span class="hl opt">-&gt;</span>movie_desired_fps <span class="hl opt">=</span> <span class="hl num">1000.0</span> <span class="hl opt">/</span> <span class="hl kwd">gtk_spin_button_get_value</span> <span class="hl opt">(</span><span class="hl kwd">GTK_SPIN_BUTTON</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>fps_spin<span class="hl opt">));</span>
    self<span class="hl opt">-&gt;</span>movie_actual_fps <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>movie_desired_fps<span class="hl opt">;</span>
    self<span class="hl opt">-&gt;</span>movie_frame_last_utime <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

<span class="hl com">/*</span>
<span class="hl com">    int wwidth, wheight;</span>
<span class="hl com">    gtk_window_get_size(GTK_WINDOW(self-&gt;window), &amp;wwidth, &amp;wheight);</span>
<span class="hl com">    printf(&quot;%5d, %5d\n&quot;, self-&gt;movie_width, self-&gt;movie_height);</span>
<span class="hl com">    gtk_widget_set_size_request(GTK_WIDGET(self-&gt;gl_area), self-&gt;movie_width, self-&gt;movie_height);</span>
<span class="hl com">    gtk_window_set_default_size(GTK_WINDOW(self-&gt;window), wwidth, wheight);</span>
<span class="hl com">    gtk_widget_set_size_request(GTK_WIDGET(self-&gt;gl_area), self-&gt;movie_width, self-&gt;movie_height);</span>
<span class="hl com">    gtk_window_set_resizable(GTK_WINDOW(self-&gt;window), FALSE);</span>
<span class="hl com">*/</span>

    self<span class="hl opt">-&gt;</span>movie_path <span class="hl opt">=</span> <span class="hl kwd">bot_fileutils_get_unique_filename</span><span class="hl opt">(</span>NULL<span class="hl opt">,</span> <span class="hl str">&quot;viewer&quot;</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> 
            <span class="hl str">&quot;ppms.gz&quot;</span><span class="hl opt">);</span>
    self<span class="hl opt">-&gt;</span>movie_gzf <span class="hl opt">=</span> <span class="hl kwd">gzopen</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_path<span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gzsetparams</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_gzf<span class="hl opt">,</span> Z_BEST_SPEED<span class="hl opt">,</span> Z_DEFAULT_STRATEGY<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_gzf <span class="hl opt">==</span> NULL<span class="hl opt">)</span>
        <span class="hl kwa">goto</span> abort_recording<span class="hl opt">;</span>
    
    <span class="hl kwd">bot_viewer_set_status_bar_message</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> <span class="hl str">&quot;Recording to: %s&quot;</span><span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_path<span class="hl opt">);</span>

    BotViewerPriv <span class="hl opt">*</span>priv <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER_GET_PRIVATE</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    priv<span class="hl opt">-&gt;</span>next_render_utime <span class="hl opt">=</span> <span class="hl kwd">bot_timestamp_now</span><span class="hl opt">();</span>
    <span class="hl kwb">double</span> render_interval_sec <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl opt">/</span> <span class="hl kwd">gtk_spin_button_get_value</span><span class="hl opt">(</span><span class="hl kwd">GTK_SPIN_BUTTON</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>fps_spin<span class="hl opt">));</span>
    priv<span class="hl opt">-&gt;</span>render_interval_usec <span class="hl opt">= (</span><span class="hl kwb">int64_t</span><span class="hl opt">)(</span>render_interval_sec <span class="hl opt">*</span> <span class="hl num">1000000</span><span class="hl opt">);</span>

    <span class="hl slc">// start a GLib timer that gets called 3 times as frequently as the video recording framerate</span>
    <span class="hl kwb">int</span> timer_interval_ms <span class="hl opt">=</span> <span class="hl kwd">MAX</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">, (</span>render_interval_sec <span class="hl opt">*</span> <span class="hl num">1000</span><span class="hl opt">) /</span> <span class="hl num">3</span><span class="hl opt">);</span>

    self<span class="hl opt">-&gt;</span>render_timer_id <span class="hl opt">=</span> <span class="hl kwd">g_timeout_add</span><span class="hl opt">(</span>timer_interval_ms<span class="hl opt">, (</span>GSourceFunc<span class="hl opt">)</span> on_render_timer<span class="hl opt">,</span> self<span class="hl opt">);</span>
    self<span class="hl opt">-&gt;</span>is_recording <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">return</span><span class="hl opt">;</span>

abort_recording<span class="hl opt">:</span>
    <span class="hl kwd">gtk_toggle_tool_button_set_active</span> <span class="hl opt">(</span>
            <span class="hl kwd">GTK_TOGGLE_TOOL_BUTTON</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>record_button<span class="hl opt">),</span>
            FALSE<span class="hl opt">);</span>
    <span class="hl kwd">free</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>mov_bgr_buf<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> 
<span class="hl kwd">bot_viewer_stop_recording</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>self<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwd">free</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_buffer<span class="hl opt">);</span>
    self<span class="hl opt">-&gt;</span>movie_buffer <span class="hl opt">=</span> NULL<span class="hl opt">;</span>

    <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">Recording stopped</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">bot_viewer_set_status_bar_message</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> <span class="hl str">&quot;Recording stopped&quot;</span><span class="hl opt">);</span>

    <span class="hl kwd">gzclose</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_gzf<span class="hl opt">);</span>
    self<span class="hl opt">-&gt;</span>movie_gzf <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
    <span class="hl kwd">free</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_path<span class="hl opt">);</span>
    self<span class="hl opt">-&gt;</span>movie_draw_pending <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwd">g_source_remove</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>render_timer_id<span class="hl opt">);</span>

    self<span class="hl opt">-&gt;</span>is_recording <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwd">gtk_toggle_tool_button_set_active</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOGGLE_TOOL_BUTTON</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>record_button<span class="hl opt">),</span>
                                       FALSE<span class="hl opt">);</span>
<span class="hl slc">//    gtk_window_set_resizable(GTK_WINDOW(self-&gt;window), TRUE);</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span> <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwb">char</span> buf<span class="hl opt">[</span><span class="hl num">1024</span><span class="hl opt">];</span>
    
    <span class="hl kwa">if</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp; !</span>viewer<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">)</span>
        viewer<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">=</span> NULL<span class="hl opt">;</span>

    <span class="hl kwb">int</span> vp<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">] = {</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">};</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area <span class="hl opt">&amp;&amp;</span>
            <span class="hl kwd">bot_gtk_gl_drawing_area_set_context</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">) ==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwd">glGetIntegerv</span><span class="hl opt">(</span>GL_VIEWPORT<span class="hl opt">,</span> vp<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwb">int</span> width <span class="hl opt">=</span> vp<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">],</span> height <span class="hl opt">=</span> vp<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">)</span>
        <span class="hl kwd">snprintf</span><span class="hl opt">(</span>buf<span class="hl opt">,</span> <span class="hl kwa">sizeof</span> <span class="hl opt">(</span>buf<span class="hl opt">),</span> <span class="hl str">&quot;%d x %d [%s]  %s&quot;</span><span class="hl opt">,</span> width<span class="hl opt">,</span> height<span class="hl opt">,</span> 
                 viewer<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>name<span class="hl opt">,</span>  viewer<span class="hl opt">-&gt;</span>status_bar_message<span class="hl opt">);</span>
    <span class="hl kwa">else</span>
        <span class="hl kwd">snprintf</span><span class="hl opt">(</span>buf<span class="hl opt">,</span> <span class="hl kwa">sizeof</span> <span class="hl opt">(</span>buf<span class="hl opt">),</span> <span class="hl str">&quot;%d x %d [Idle] %s&quot;</span><span class="hl opt">,</span> width<span class="hl opt">,</span> height<span class="hl opt">,</span>
                 viewer<span class="hl opt">-&gt;</span>status_bar_message<span class="hl opt">);</span>

    <span class="hl kwd">gtk_statusbar_push</span><span class="hl opt">(</span><span class="hl kwd">GTK_STATUSBAR</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>status_bar<span class="hl opt">),</span> 
                       <span class="hl kwd">gtk_statusbar_get_context_id</span><span class="hl opt">(</span>
                           <span class="hl kwd">GTK_STATUSBAR</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>status_bar<span class="hl opt">),</span><span class="hl str">&quot;info&quot;</span><span class="hl opt">),</span> buf<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_set_status_bar_message</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> <span class="hl kwb">const char</span> <span class="hl opt">*</span>fmt<span class="hl opt">, ...)</span>
<span class="hl opt">{</span>
    <span class="hl kwb">char</span> buf<span class="hl opt">[</span><span class="hl num">1024</span><span class="hl opt">];</span>
    <span class="hl kwb">va_list</span> ap<span class="hl opt">;</span>
    <span class="hl kwd">va_start</span> <span class="hl opt">(</span>ap<span class="hl opt">,</span> fmt<span class="hl opt">);</span>
    <span class="hl kwd">vsnprintf</span> <span class="hl opt">(</span>buf<span class="hl opt">,</span> <span class="hl kwa">sizeof</span> <span class="hl opt">(</span>buf<span class="hl opt">),</span> fmt<span class="hl opt">,</span> ap<span class="hl opt">);</span>
    <span class="hl kwd">va_end</span> <span class="hl opt">(</span>ap<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>status_bar_message<span class="hl opt">)</span>
        <span class="hl kwd">free</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>status_bar_message<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>status_bar_message <span class="hl opt">=</span> <span class="hl kwd">strdup</span><span class="hl opt">(</span>buf<span class="hl opt">);</span>

    <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span>
<span class="hl kwd">bot_viewer_load_preferences</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> <span class="hl kwb">const char</span> <span class="hl opt">*</span>fname<span class="hl opt">)</span>
<span class="hl opt">{</span>

    BotViewerPriv<span class="hl opt">*</span> priv <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER_GET_PRIVATE</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>

    GKeyFile <span class="hl opt">*</span>preferences <span class="hl opt">=</span> <span class="hl kwd">g_key_file_new</span> <span class="hl opt">();</span>
    <span class="hl kwb">int</span> loaded <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">g_file_test</span> <span class="hl opt">(</span>fname<span class="hl opt">,</span> G_FILE_TEST_IS_REGULAR<span class="hl opt">)) {</span>
        loaded <span class="hl opt">=</span> <span class="hl kwd">g_key_file_load_from_file</span> <span class="hl opt">(</span>preferences<span class="hl opt">,</span> fname<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> NULL<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(!</span>loaded<span class="hl opt">)</span> <span class="hl kwa">goto</span> done<span class="hl opt">;</span>
    <span class="hl kwd">dbg</span> <span class="hl opt">(</span><span class="hl str">&quot;loading viewer settings from %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">);</span>
        
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> ridx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> ridx <span class="hl opt">&lt;</span> viewer<span class="hl opt">-&gt;</span>renderers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> ridx<span class="hl opt">++) {</span>
        BotRenderer <span class="hl opt">*</span>renderer <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>renderers<span class="hl opt">,</span> ridx<span class="hl opt">);</span>
        GtkCheckMenuItem <span class="hl opt">*</span>cmi <span class="hl opt">=</span> <span class="hl kwd">GTK_CHECK_MENU_ITEM</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">);</span>

        GError <span class="hl opt">*</span>err <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
        <span class="hl kwb">int</span> enabled <span class="hl opt">=</span> <span class="hl kwd">g_key_file_get_boolean</span> <span class="hl opt">(</span>preferences<span class="hl opt">,</span>
                <span class="hl str">&quot;__libviewer_enabled_renderers&quot;</span><span class="hl opt">,</span> renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">, &amp;</span>err<span class="hl opt">);</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>err<span class="hl opt">) {</span>
            <span class="hl kwd">err</span> <span class="hl opt">(</span><span class="hl str">&quot;%s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> err<span class="hl opt">-&gt;</span>message<span class="hl opt">);</span>
            <span class="hl kwd">g_error_free</span> <span class="hl opt">(</span>err<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwd">gtk_check_menu_item_set_active</span> <span class="hl opt">(</span>cmi<span class="hl opt">,</span> enabled<span class="hl opt">);</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">g_key_file_has_key</span> <span class="hl opt">(</span>preferences<span class="hl opt">,</span> <span class="hl str">&quot;__libviewer_show_renderers&quot;</span><span class="hl opt">,</span> 
                        renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">,</span> NULL<span class="hl opt">)) {</span>
                renderer<span class="hl opt">-&gt;</span>expanded <span class="hl opt">=</span> <span class="hl kwd">g_key_file_get_boolean</span> <span class="hl opt">(</span>preferences<span class="hl opt">,</span> 
                        <span class="hl str">&quot;__libviewer_show_renderers&quot;</span><span class="hl opt">,</span> renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">,</span> NULL<span class="hl opt">);</span>
                <span class="hl kwd">gtk_expander_set_expanded</span> <span class="hl opt">(</span><span class="hl kwd">GTK_EXPANDER</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>expander<span class="hl opt">),</span>
                        renderer<span class="hl opt">-&gt;</span>expanded<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    
    <span class="hl slc">// load bookmarks to preferences</span>
    <span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwd">g_key_file_has_group</span><span class="hl opt">(</span>preferences<span class="hl opt">,</span> <span class="hl str">&quot;__libviewer_bookmarks&quot;</span><span class="hl opt">))</span>
    <span class="hl opt">{</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> bm_indx<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> bm_indx <span class="hl opt">&lt;</span> priv<span class="hl opt">-&gt;</span>num_bookmarks<span class="hl opt">;</span> bm_indx<span class="hl opt">++) {</span>
            GError <span class="hl opt">*</span>err <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
            <span class="hl kwb">char</span> <span class="hl opt">*</span>str_key<span class="hl opt">;</span>   
            str_key <span class="hl opt">=</span> <span class="hl kwd">g_strdup_printf</span><span class="hl opt">(</span><span class="hl str">&quot;bookmark_%d&quot;</span><span class="hl opt">,</span> bm_indx<span class="hl opt">);</span>

            <span class="hl kwb">int</span> bmlist_len <span class="hl opt">=</span> <span class="hl num">11</span><span class="hl opt">;</span>      
            <span class="hl kwa">if</span><span class="hl opt">(!</span><span class="hl kwd">g_key_file_has_key</span><span class="hl opt">(</span>preferences<span class="hl opt">,</span> <span class="hl str">&quot;__libviewer_bookmarks&quot;</span><span class="hl opt">,</span> str_key<span class="hl opt">,</span> NULL<span class="hl opt">))</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
            <span class="hl kwb">double</span><span class="hl opt">*</span> pointtolist <span class="hl opt">=</span> 
                <span class="hl kwd">g_key_file_get_double_list</span><span class="hl opt">(</span>preferences<span class="hl opt">,</span> <span class="hl str">&quot;__libviewer_bookmarks&quot;</span><span class="hl opt">,</span> 
                        str_key<span class="hl opt">, (</span>gsize<span class="hl opt">*) &amp;</span>bmlist_len<span class="hl opt">, &amp;</span>err<span class="hl opt">);</span>
            <span class="hl kwa">if</span><span class="hl opt">(</span>err<span class="hl opt">) {</span>
                <span class="hl kwd">g_error_free</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
                <span class="hl kwa">continue</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> i<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">&lt;</span><span class="hl num">3</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
                priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>eye<span class="hl opt">[</span>i<span class="hl opt">] =</span> pointtolist<span class="hl opt">[</span>i<span class="hl opt">];</span>
                priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>lookat<span class="hl opt">[</span>i<span class="hl opt">] =</span> pointtolist<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">+</span>i<span class="hl opt">];</span>
                priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>up<span class="hl opt">[</span>i<span class="hl opt">] =</span> pointtolist<span class="hl opt">[</span><span class="hl num">6</span><span class="hl opt">+</span>i<span class="hl opt">];</span>
            <span class="hl opt">}</span>
            priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>projection_mode <span class="hl opt">=(</span><span class="hl kwb">int</span><span class="hl opt">)</span> pointtolist<span class="hl opt">[</span><span class="hl num">9</span><span class="hl opt">];</span>
            priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>saved <span class="hl opt">=</span> pointtolist<span class="hl opt">[</span><span class="hl num">10</span><span class="hl opt">];</span>
            <span class="hl kwd">free</span><span class="hl opt">(</span>pointtolist<span class="hl opt">);</span>
            <span class="hl kwd">g_free</span><span class="hl opt">(</span>str_key<span class="hl opt">);</span>

        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">g_signal_emit</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>viewer<span class="hl opt">),</span> bot_viewer_signals<span class="hl opt">[</span>LOAD_PREFERENCES_SIGNAL<span class="hl opt">],</span> <span class="hl num">0</span><span class="hl opt">,</span> preferences<span class="hl opt">);</span>

done<span class="hl opt">:</span>
    <span class="hl kwd">g_key_file_free</span> <span class="hl opt">(</span>preferences<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span>
<span class="hl kwd">bot_viewer_save_preferences</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> <span class="hl kwb">const char</span> <span class="hl opt">*</span>fname<span class="hl opt">)</span>
<span class="hl opt">{</span>
    GKeyFile <span class="hl opt">*</span>preferences <span class="hl opt">=</span> <span class="hl kwd">g_key_file_new</span> <span class="hl opt">();</span>
    BotViewerPriv<span class="hl opt">*</span> priv <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER_GET_PRIVATE</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>

    <span class="hl kwd">dbg</span> <span class="hl opt">(</span><span class="hl str">&quot;saving viewer settings...</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> ridx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> ridx <span class="hl opt">&lt;</span> viewer<span class="hl opt">-&gt;</span>renderers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> ridx<span class="hl opt">++) {</span>
        BotRenderer <span class="hl opt">*</span>renderer <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>renderers<span class="hl opt">,</span> ridx<span class="hl opt">);</span>

        <span class="hl kwd">g_key_file_set_boolean</span> <span class="hl opt">(</span>preferences<span class="hl opt">,</span> <span class="hl str">&quot;__libviewer_enabled_renderers&quot;</span><span class="hl opt">,</span>
                renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">,</span> renderer<span class="hl opt">-&gt;</span>enabled<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">) {</span>
            <span class="hl kwd">g_key_file_set_boolean</span> <span class="hl opt">(</span>preferences<span class="hl opt">,</span> <span class="hl str">&quot;__libviewer_show_renderers&quot;</span><span class="hl opt">,</span>
                    renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">,</span> renderer<span class="hl opt">-&gt;</span>expanded<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// save bookmarks to prefs</span>
    <span class="hl kwb">int</span> bmlist_len <span class="hl opt">=</span> <span class="hl num">11</span><span class="hl opt">;</span>
    <span class="hl kwb">char</span> <span class="hl opt">*</span>str_key<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> bm_indx<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> bm_indx <span class="hl opt">&lt;</span> priv<span class="hl opt">-&gt;</span>num_bookmarks<span class="hl opt">;</span> bm_indx<span class="hl opt">++) {</span> 
        str_key <span class="hl opt">=</span> <span class="hl kwd">g_strdup_printf</span><span class="hl opt">(</span><span class="hl str">&quot;bookmark_%d&quot;</span><span class="hl opt">,</span> bm_indx<span class="hl opt">);</span>
        <span class="hl kwb">double</span> bmlist<span class="hl opt">[</span>bmlist_len<span class="hl opt">];</span> 
        <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwb">int</span> i<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">&lt;</span><span class="hl num">3</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
            bmlist<span class="hl opt">[</span>i<span class="hl opt">] =</span> priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>eye<span class="hl opt">[</span>i<span class="hl opt">];</span>
            bmlist<span class="hl opt">[</span>i<span class="hl opt">+</span><span class="hl num">3</span><span class="hl opt">] =</span> priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>lookat<span class="hl opt">[</span>i<span class="hl opt">];</span>
            bmlist<span class="hl opt">[</span>i<span class="hl opt">+</span><span class="hl num">6</span><span class="hl opt">] =</span> priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>up<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl opt">}</span>
        bmlist<span class="hl opt">[</span><span class="hl num">9</span><span class="hl opt">] = (</span><span class="hl kwb">double</span><span class="hl opt">)</span>priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>projection_mode<span class="hl opt">;</span>
        bmlist<span class="hl opt">[</span><span class="hl num">10</span><span class="hl opt">] =</span> priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bm_indx<span class="hl opt">].</span>saved<span class="hl opt">;</span>
        <span class="hl kwd">g_key_file_set_double_list</span><span class="hl opt">(</span>preferences<span class="hl opt">,</span> <span class="hl str">&quot;__libviewer_bookmarks&quot;</span><span class="hl opt">,</span> str_key<span class="hl opt">,</span> bmlist<span class="hl opt">,</span> bmlist_len<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">g_free</span><span class="hl opt">(</span>str_key<span class="hl opt">);</span>

    <span class="hl kwb">FILE</span> <span class="hl opt">*</span>fp <span class="hl opt">=</span> <span class="hl kwd">fopen</span> <span class="hl opt">(</span>fname<span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>fp<span class="hl opt">) {</span>
        <span class="hl kwd">perror</span> <span class="hl opt">(</span><span class="hl str">&quot;error saving preferences&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwd">g_signal_emit</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">),</span> bot_viewer_signals<span class="hl opt">[</span>SAVE_PREFERENCES_SIGNAL<span class="hl opt">],</span> 
            <span class="hl num">0</span><span class="hl opt">,</span> preferences<span class="hl opt">);</span>

    gsize len <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwb">char</span> <span class="hl opt">*</span>data <span class="hl opt">=</span> <span class="hl kwd">g_key_file_to_data</span> <span class="hl opt">(</span>preferences<span class="hl opt">, &amp;</span>len<span class="hl opt">,</span> NULL<span class="hl opt">);</span>
    <span class="hl kwd">fwrite</span> <span class="hl opt">(</span>data<span class="hl opt">,</span> len<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> fp<span class="hl opt">);</span>
    <span class="hl kwd">free</span> <span class="hl opt">(</span>data<span class="hl opt">);</span>

    <span class="hl kwd">fclose</span> <span class="hl opt">(</span>fp<span class="hl opt">);</span>
    <span class="hl kwd">g_key_file_free</span> <span class="hl opt">(</span>preferences<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl slc">// ============== event handlers ===========</span>

<span class="hl kwb">static</span> gboolean
<span class="hl kwd">on_gl_configure</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventConfigure <span class="hl opt">*</span>event<span class="hl opt">,</span> <span class="hl kwb">void</span><span class="hl opt">*</span> user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span> self <span class="hl opt">= (</span>BotViewer <span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>self<span class="hl opt">);</span> <span class="hl slc">// redraw our window size</span>
    <span class="hl kwd">bot_viewer_request_redraw</span> <span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean <span class="hl kwd">on_redraw_timer</span><span class="hl opt">(</span><span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span> self <span class="hl opt">= (</span>BotViewer <span class="hl opt">*)</span> user_data<span class="hl opt">;</span>
    self<span class="hl opt">-&gt;</span>redraw_timer_pending <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwd">bot_viewer_request_redraw</span> <span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl kwa">return</span> FALSE<span class="hl opt">;</span> <span class="hl slc">// this is a one-shot event.</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span> 
<span class="hl kwd">check_gl_errors</span> <span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>label<span class="hl opt">) {</span>
    GLenum errCode <span class="hl opt">=</span> <span class="hl kwd">glGetError</span> <span class="hl opt">();</span>
    <span class="hl kwb">const</span> GLubyte <span class="hl opt">*</span>errStr<span class="hl opt">;</span>
    
    <span class="hl kwa">while</span> <span class="hl opt">(</span>errCode <span class="hl opt">!=</span> GL_NO_ERROR<span class="hl opt">) {</span>
        errStr <span class="hl opt">=</span> <span class="hl kwd">gluErrorString</span><span class="hl opt">(</span>errCode<span class="hl opt">);</span>
        <span class="hl kwd">fprintf</span> <span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;OpenGL Error on draw #%d (%s)</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> g_draws<span class="hl opt">,</span> label<span class="hl opt">);</span>
        <span class="hl kwd">fprintf</span> <span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;%s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">, (</span><span class="hl kwb">char</span><span class="hl opt">*)</span>errStr<span class="hl opt">);</span>
        errCode <span class="hl opt">=</span> <span class="hl kwd">glGetError</span> <span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">render_scene</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>self<span class="hl opt">)</span>
<span class="hl opt">{</span>
<span class="hl slc">//    glClearColor (0.0, 0.0, 0.0, 1.0);</span>
    <span class="hl kwd">glClearColor</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">],</span> self<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">],</span> 
                 self<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">],</span> self<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">]);</span>
    <span class="hl kwd">glClear</span> <span class="hl opt">(</span>GL_COLOR_BUFFER_BIT <span class="hl opt">|</span> GL_DEPTH_BUFFER_BIT<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">)</span>
        self<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">-&gt;</span><span class="hl kwd">update_gl_matrices</span><span class="hl opt">(</span>self<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">);</span>

    <span class="hl kwd">glMatrixMode</span> <span class="hl opt">(</span>GL_MODELVIEW<span class="hl opt">);</span>

    <span class="hl com">/* give the ambient light a blue tint to match the blue sky */</span>
    <span class="hl kwb">float</span> light0_amb<span class="hl opt">[] = {</span> <span class="hl num">0.8</span><span class="hl opt">,</span> <span class="hl num">0.8</span><span class="hl opt">,</span> <span class="hl num">1.0</span><span class="hl opt">,</span> <span class="hl num">1</span> <span class="hl opt">};</span>
    <span class="hl kwb">float</span> light0_dif<span class="hl opt">[] = {</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl num">1</span> <span class="hl opt">};</span>
    <span class="hl kwb">float</span> light0_spe<span class="hl opt">[] = {</span> <span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">1</span> <span class="hl opt">};</span>
    <span class="hl kwb">float</span> light0_pos<span class="hl opt">[] = {</span> <span class="hl num">100</span><span class="hl opt">,</span> <span class="hl num">100</span><span class="hl opt">,</span> <span class="hl num">100</span><span class="hl opt">,</span> <span class="hl num">0</span> <span class="hl opt">};</span>
    <span class="hl kwd">glLightfv</span> <span class="hl opt">(</span>GL_LIGHT0<span class="hl opt">,</span> GL_AMBIENT<span class="hl opt">,</span> light0_amb<span class="hl opt">);</span>
    <span class="hl kwd">glLightfv</span> <span class="hl opt">(</span>GL_LIGHT0<span class="hl opt">,</span> GL_DIFFUSE<span class="hl opt">,</span> light0_dif<span class="hl opt">);</span>
    <span class="hl kwd">glLightfv</span> <span class="hl opt">(</span>GL_LIGHT0<span class="hl opt">,</span> GL_SPECULAR<span class="hl opt">,</span> light0_spe<span class="hl opt">);</span>
    <span class="hl kwd">glLightfv</span> <span class="hl opt">(</span>GL_LIGHT0<span class="hl opt">,</span> GL_POSITION<span class="hl opt">,</span> light0_pos<span class="hl opt">);</span>
    <span class="hl kwd">glEnable</span> <span class="hl opt">(</span>GL_LIGHT0<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>prettier_flag<span class="hl opt">) {</span>
        <span class="hl kwd">glEnable</span><span class="hl opt">(</span>GL_LINE_STIPPLE<span class="hl opt">);</span>
        <span class="hl kwd">glEnable</span><span class="hl opt">(</span>GL_LINE_SMOOTH<span class="hl opt">);</span>
        <span class="hl kwd">glHint</span><span class="hl opt">(</span>GL_LINE_SMOOTH_HINT<span class="hl opt">,</span> GL_NICEST<span class="hl opt">);</span>
        <span class="hl kwd">glEnable</span><span class="hl opt">(</span>GL_POINT_SMOOTH<span class="hl opt">);</span>
        <span class="hl kwd">glHint</span><span class="hl opt">(</span>GL_POINT_SMOOTH_HINT<span class="hl opt">,</span> GL_NICEST<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> ridx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> ridx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> ridx<span class="hl opt">++) {</span>
        BotRenderer <span class="hl opt">*</span>renderer <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">,</span> ridx<span class="hl opt">);</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>enabled<span class="hl opt">) {</span>
            
            <span class="hl kwd">glPushAttrib</span><span class="hl opt">(</span>GL_ENABLE_BIT <span class="hl opt">|</span> GL_POINT_BIT <span class="hl opt">|</span> GL_POLYGON_STIPPLE_BIT <span class="hl opt">|</span> 
                         GL_POLYGON_BIT <span class="hl opt">|</span> GL_LINE_BIT <span class="hl opt">|</span> GL_FOG_BIT <span class="hl opt">|</span> GL_LIGHTING_BIT <span class="hl opt">);</span>
            <span class="hl kwd">glPushMatrix</span><span class="hl opt">();</span>

            <span class="hl kwa">if</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>draw<span class="hl opt">)</span>
                renderer<span class="hl opt">-&gt;</span><span class="hl kwd">draw</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> renderer<span class="hl opt">);</span>

            <span class="hl kwd">check_gl_errors</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">);</span>

            <span class="hl kwd">glPopMatrix</span><span class="hl opt">();</span>
            <span class="hl kwd">glPopAttrib</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean
<span class="hl kwd">on_gl_expose</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventExpose <span class="hl opt">*</span>event<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span> self <span class="hl opt">= (</span>BotViewer <span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl slc">// if not enough time has elapsed since our last redraw, we</span>
    <span class="hl slc">// schedule a redraw in the future (if one isn't already pending).</span>
    <span class="hl kwb">int64_t</span> now <span class="hl opt">=</span> <span class="hl kwd">bot_timestamp_now</span><span class="hl opt">();</span>
    <span class="hl kwb">double</span> dt <span class="hl opt">= (</span>now <span class="hl opt">-</span> self<span class="hl opt">-&gt;</span>last_draw_utime<span class="hl opt">) /</span> <span class="hl num">1000000.0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>dt <span class="hl opt">&lt; (</span><span class="hl num">1.0</span><span class="hl opt">/</span>MAX_REDRAW_HZ<span class="hl opt">)) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>self<span class="hl opt">-&gt;</span>redraw_timer_pending<span class="hl opt">) {</span>
            <span class="hl kwb">int</span> delay_ms <span class="hl opt">= (</span>now <span class="hl opt">-</span> self<span class="hl opt">-&gt;</span>last_draw_utime<span class="hl opt">)/</span><span class="hl num">1000</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl kwd">g_timeout_add</span><span class="hl opt">(</span>delay_ms<span class="hl opt">,</span> on_redraw_timer<span class="hl opt">,</span> self<span class="hl opt">);</span>
            self<span class="hl opt">-&gt;</span>redraw_timer_pending <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    self<span class="hl opt">-&gt;</span>last_draw_utime <span class="hl opt">=</span> now<span class="hl opt">;</span>

    <span class="hl slc">// If we're making a movie, don't draw any faster than the</span>
    <span class="hl slc">// requested movie FPS rate.</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_gzf <span class="hl opt">&amp;&amp; !</span>self<span class="hl opt">-&gt;</span>movie_draw_pending<span class="hl opt">)</span>
        <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>

    <span class="hl slc">// set this to 1 in order to cause viewer to exit cleanly after a</span>
    <span class="hl slc">// few hundred frames: useful for generating gprof output.</span>
    g_draws<span class="hl opt">++;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwb">int</span> thresh <span class="hl opt">=</span> <span class="hl num">300</span><span class="hl opt">;</span>

        <span class="hl slc">// for profiling PROFILE</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>g_draws<span class="hl opt">%</span><span class="hl num">50</span> <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span>
            <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;draws: %5i / %i</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> g_draws<span class="hl opt">,</span> thresh<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>g_draws <span class="hl opt">==</span> thresh<span class="hl opt">) {</span>
            <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;Profiling is enabled: exiting now</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
            <span class="hl kwd">exit</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    
    <span class="hl slc">// we're going to actually draw.</span>
    
    <span class="hl kwd">bot_gtk_gl_drawing_area_set_context</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_emit</span><span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>self<span class="hl opt">),</span> bot_viewer_signals<span class="hl opt">[</span>RENDER_BEGIN_SIGNAL<span class="hl opt">],</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">render_scene</span> <span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_emit</span><span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>self<span class="hl opt">),</span> bot_viewer_signals<span class="hl opt">[</span>RENDER_END_SIGNAL<span class="hl opt">],</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">bot_gtk_gl_drawing_area_swap_buffers</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">);</span>
    
    <span class="hl slc">// write a movie frame?</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_draw_pending<span class="hl opt">) {</span>
        <span class="hl kwa">assert</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_gzf<span class="hl opt">);</span>

        <span class="hl kwd">glReadPixels</span> <span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_width<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_height<span class="hl opt">,</span> GL_RGB<span class="hl opt">,</span> GL_UNSIGNED_BYTE<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_buffer<span class="hl opt">);</span> 
        
        <span class="hl kwd">gzprintf</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_gzf<span class="hl opt">,</span> <span class="hl str">&quot;P6 %d %d %d</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_width<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_height<span class="hl opt">,</span> <span class="hl num">255</span><span class="hl opt">);</span>
        
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> h <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>movie_height <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> h <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> h<span class="hl opt">--) {</span>
            <span class="hl kwb">int</span> offset <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>movie_stride <span class="hl opt">*</span> h<span class="hl opt">;</span>
            <span class="hl kwd">gzwrite</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_gzf<span class="hl opt">, &amp;</span>self<span class="hl opt">-&gt;</span>movie_buffer<span class="hl opt">[</span>offset<span class="hl opt">],</span> self<span class="hl opt">-&gt;</span>movie_stride<span class="hl opt">);</span>
        <span class="hl opt">}</span>

        self<span class="hl opt">-&gt;</span>movie_draw_pending <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwb">int64_t</span> now <span class="hl opt">=</span> <span class="hl kwd">bot_timestamp_now</span><span class="hl opt">();</span>
        <span class="hl kwb">double</span> dt<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>movie_frame_last_utime <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span>
            dt <span class="hl opt">=</span> <span class="hl num">1.0</span> <span class="hl opt">/</span> self<span class="hl opt">-&gt;</span>movie_desired_fps<span class="hl opt">;</span>
        <span class="hl kwa">else</span>
            dt <span class="hl opt">= (</span>now <span class="hl opt">-</span> self<span class="hl opt">-&gt;</span>movie_frame_last_utime<span class="hl opt">)/</span><span class="hl num">1000000.0</span><span class="hl opt">;</span>
        <span class="hl kwb">double</span> fps <span class="hl opt">=</span> <span class="hl num">1.0</span> <span class="hl opt">/</span> dt<span class="hl opt">;</span>
        self<span class="hl opt">-&gt;</span>movie_frame_last_utime <span class="hl opt">=</span> now<span class="hl opt">;</span>
        <span class="hl kwb">double</span> alpha <span class="hl opt">=</span> <span class="hl num">0.8</span><span class="hl opt">;</span> <span class="hl slc">// higher = lower-pass</span>
        self<span class="hl opt">-&gt;</span>movie_actual_fps <span class="hl opt">=</span> alpha <span class="hl opt">*</span> self<span class="hl opt">-&gt;</span>movie_actual_fps <span class="hl opt">+ (</span><span class="hl num">1</span> <span class="hl opt">-</span> alpha<span class="hl opt">) *</span> fps<span class="hl opt">;</span>
        self<span class="hl opt">-&gt;</span>movie_frames<span class="hl opt">++;</span>

        <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;%20s %6d (%5.2f fps)</span><span class="hl esc">\r</span><span class="hl str">&quot;</span><span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_path<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_frames<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>movie_actual_fps<span class="hl opt">);</span>
        <span class="hl kwd">fflush</span><span class="hl opt">(</span>NULL<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> GLint
<span class="hl kwd">mygluUnProject</span> <span class="hl opt">(</span><span class="hl kwb">double</span> winx<span class="hl opt">,</span> <span class="hl kwb">double</span> winy<span class="hl opt">,</span> <span class="hl kwb">double</span> winz<span class="hl opt">,</span>
        <span class="hl kwb">const double</span> model<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">],</span> <span class="hl kwb">const double</span> proj<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">],</span> <span class="hl kwb">const int</span> viewport<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">],</span>
        <span class="hl kwb">double</span> <span class="hl opt">*</span> objx<span class="hl opt">,</span> <span class="hl kwb">double</span> <span class="hl opt">*</span> objy<span class="hl opt">,</span> <span class="hl kwb">double</span> <span class="hl opt">*</span> objz<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwb">double</span> p<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">],</span> m<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">];</span>
    <span class="hl kwd">bot_matrix_transpose_4x4d</span> <span class="hl opt">(</span>proj<span class="hl opt">,</span> p<span class="hl opt">);</span>
    <span class="hl kwd">bot_matrix_transpose_4x4d</span> <span class="hl opt">(</span>model<span class="hl opt">,</span> m<span class="hl opt">);</span>
    <span class="hl kwb">double</span> t<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">];</span>
    <span class="hl kwd">bot_matrix_multiply_4x4_4x4</span> <span class="hl opt">(</span>p<span class="hl opt">,</span> m<span class="hl opt">,</span> t<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">bot_matrix_inverse_4x4d</span> <span class="hl opt">(</span>t<span class="hl opt">,</span> m<span class="hl opt">) &lt;</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> GL_FALSE<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>viewport<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] ==</span> <span class="hl num">0</span> <span class="hl opt">||</span> viewport<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> GL_FALSE<span class="hl opt">;</span>
    <span class="hl kwb">double</span> v<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">] = {</span>
        <span class="hl num">2</span> <span class="hl opt">* (</span>winx <span class="hl opt">-</span> viewport<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]) /</span> viewport<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] -</span> <span class="hl num">1</span><span class="hl opt">,</span>
        <span class="hl num">2</span> <span class="hl opt">* (</span>winy <span class="hl opt">-</span> viewport<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]) /</span> viewport<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">] -</span> <span class="hl num">1</span><span class="hl opt">,</span>
        <span class="hl num">2</span> <span class="hl opt">*</span> winz <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span>
        <span class="hl num">1</span><span class="hl opt">,</span>
    <span class="hl opt">};</span>
    <span class="hl kwb">double</span> v2<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">];</span>
    <span class="hl kwd">bot_matrix_vector_multiply_4x4_4d</span> <span class="hl opt">(</span>m<span class="hl opt">,</span> v<span class="hl opt">,</span> v2<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>v2<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> GL_FALSE<span class="hl opt">;</span>
    <span class="hl opt">*</span>objx <span class="hl opt">=</span> v2<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] /</span> v2<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl opt">*</span>objy <span class="hl opt">=</span> v2<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] /</span> v2<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl opt">*</span>objz <span class="hl opt">=</span> v2<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] /</span> v2<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwa">return</span> GL_TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static int</span>
<span class="hl kwd">_window_coord_to_ray</span> <span class="hl opt">(</span><span class="hl kwb">double</span> x<span class="hl opt">,</span> <span class="hl kwb">double</span> y<span class="hl opt">,</span> <span class="hl kwb">double</span> ray_start<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">],</span> <span class="hl kwb">double</span> ray_dir<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">])</span>
<span class="hl opt">{</span>
    GLdouble model_matrix<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">];</span>
    GLdouble proj_matrix<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">];</span>
    GLint viewport<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">];</span>

    <span class="hl kwd">glGetDoublev</span> <span class="hl opt">(</span>GL_MODELVIEW_MATRIX<span class="hl opt">,</span> model_matrix<span class="hl opt">);</span>
    <span class="hl kwd">glGetDoublev</span> <span class="hl opt">(</span>GL_PROJECTION_MATRIX<span class="hl opt">,</span> proj_matrix<span class="hl opt">);</span>
    <span class="hl kwd">glGetIntegerv</span> <span class="hl opt">(</span>GL_VIEWPORT<span class="hl opt">,</span> viewport<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">mygluUnProject</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span>
                      model_matrix<span class="hl opt">,</span> proj_matrix<span class="hl opt">,</span> viewport<span class="hl opt">,</span> 
                      <span class="hl opt">&amp;</span>ray_start<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">], &amp;</span>ray_start<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">], &amp;</span>ray_start<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]) ==</span> GL_FALSE<span class="hl opt">)</span> 
        <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">;</span>
    
    <span class="hl kwb">double</span> ray_end<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">mygluUnProject</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span>
                      model_matrix<span class="hl opt">,</span> proj_matrix<span class="hl opt">,</span> viewport<span class="hl opt">,</span> 
                      <span class="hl opt">&amp;</span>ray_end<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">], &amp;</span>ray_end<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">], &amp;</span>ray_end<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]) ==</span> GL_FALSE<span class="hl opt">)</span> 
        <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">;</span>

    ray_dir<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> ray_end<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] -</span> ray_start<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
    ray_dir<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] =</span> ray_end<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] -</span> ray_start<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">];</span>
    ray_dir<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] =</span> ray_end<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] -</span> ray_start<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">];</span>
            
    <span class="hl kwd">bot_vector_normalize_3d</span><span class="hl opt">(</span>ray_dir<span class="hl opt">);</span>

    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean 
<span class="hl kwd">on_button_press</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventButton <span class="hl opt">*</span>event<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwd">bot_gtk_gl_drawing_area_set_context</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">);</span>
    <span class="hl kwb">double</span> ray_start<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwb">double</span> ray_dir<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwd">_window_coord_to_ray</span> <span class="hl opt">(</span>event<span class="hl opt">-&gt;</span>x<span class="hl opt">,</span> widget<span class="hl opt">-&gt;</span>allocation<span class="hl opt">.</span>height <span class="hl opt">-</span> event<span class="hl opt">-&gt;</span>y<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">);</span>

    <span class="hl slc">// find a new picker?</span>
    <span class="hl kwb">double</span> best_distance <span class="hl opt">=</span> HUGE<span class="hl opt">;</span>
    BotEventHandler <span class="hl opt">*</span>best_handler <span class="hl opt">=</span> NULL<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">==</span> NULL <span class="hl opt">||</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">==</span><span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
            BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
            
            <span class="hl kwa">if</span> <span class="hl opt">(</span>handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>pick_query<span class="hl opt">) {</span>
                <span class="hl kwb">double</span> this_distance <span class="hl opt">=</span> handler<span class="hl opt">-&gt;</span><span class="hl kwd">pick_query</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">);</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>this_distance <span class="hl opt">&lt;</span> best_distance <span class="hl opt">&amp;&amp;</span> this_distance <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
                    best_distance <span class="hl opt">=</span> this_distance<span class="hl opt">;</span>
                    best_handler <span class="hl opt">=</span> handler<span class="hl opt">;</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>

        <span class="hl slc">// notify the new handler</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>best_handler<span class="hl opt">)</span>
            <span class="hl kwd">bot_viewer_request_pick</span><span class="hl opt">(</span>self<span class="hl opt">,</span> best_handler<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// give picking handler first dibs</span>
    <span class="hl kwb">int</span> consumed <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp; !</span>self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">)</span>
        self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>mouse_press<span class="hl opt">) {</span>
        consumed <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_press</span><span class="hl opt">(</span>self<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">);</span>
        <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// try all the other handlers in order of priority</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> 
            <span class="hl opt">!</span>consumed <span class="hl opt">&amp;&amp;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        
        <span class="hl kwa">if</span> <span class="hl opt">(</span>handler <span class="hl opt">!=</span> self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>mouse_press<span class="hl opt">)</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_press</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">))</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean
<span class="hl kwd">on_button_release</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventButton <span class="hl opt">*</span>event<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwd">bot_gtk_gl_drawing_area_set_context</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">);</span>
    <span class="hl kwb">double</span> ray_start<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwb">double</span> ray_dir<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwd">_window_coord_to_ray</span> <span class="hl opt">(</span>event<span class="hl opt">-&gt;</span>x<span class="hl opt">,</span> widget<span class="hl opt">-&gt;</span>allocation<span class="hl opt">.</span>height <span class="hl opt">-</span> event<span class="hl opt">-&gt;</span>y<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">);</span>

    <span class="hl slc">// give picking handler first dibs</span>
    <span class="hl kwb">int</span> consumed <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp; !</span>self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">)</span>
        self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>mouse_release<span class="hl opt">) {</span>
        consumed <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_release</span><span class="hl opt">(</span>self<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">);</span>
        <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// try all the other handlers in order of priority</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; !</span>consumed <span class="hl opt">&amp;&amp;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        
        <span class="hl kwa">if</span> <span class="hl opt">(</span>handler <span class="hl opt">!=</span> self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>mouse_release<span class="hl opt">)</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_release</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">))</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean 
<span class="hl kwd">on_motion_notify</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventMotion <span class="hl opt">*</span>event<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwd">bot_gtk_gl_drawing_area_set_context</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">);</span>
    <span class="hl kwb">double</span> ray_start<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwb">double</span> ray_dir<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwd">_window_coord_to_ray</span> <span class="hl opt">(</span>event<span class="hl opt">-&gt;</span>x<span class="hl opt">,</span> widget<span class="hl opt">-&gt;</span>allocation<span class="hl opt">.</span>height <span class="hl opt">-</span> event<span class="hl opt">-&gt;</span>y<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">);</span>
    
    <span class="hl slc">// is anyone hovering?</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">==</span> NULL <span class="hl opt">|| !</span>self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">) {</span>

        <span class="hl slc">// find a new hover?</span>
        <span class="hl kwb">double</span> best_distance <span class="hl opt">=</span> HUGE<span class="hl opt">;</span>
        BotEventHandler <span class="hl opt">*</span>best_handler <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
        
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
            BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
            
            handler<span class="hl opt">-&gt;</span>hovering <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

            <span class="hl kwa">if</span> <span class="hl opt">(</span>handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>hover_query<span class="hl opt">) {</span>
                <span class="hl kwb">double</span> this_distance <span class="hl opt">=</span> handler<span class="hl opt">-&gt;</span><span class="hl kwd">hover_query</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">);</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>this_distance <span class="hl opt">&lt;</span> best_distance <span class="hl opt">&amp;&amp;</span> this_distance <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
                    best_distance <span class="hl opt">=</span> this_distance<span class="hl opt">;</span>
                    best_handler <span class="hl opt">=</span> handler<span class="hl opt">;</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>

        <span class="hl slc">// notify the new handler</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>best_handler<span class="hl opt">)</span>
            best_handler<span class="hl opt">-&gt;</span>hovering <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>

        <span class="hl kwd">bot_viewer_request_redraw</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// give picking handler first dibs</span>
    <span class="hl kwb">int</span> consumed <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp; !</span>self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">)</span>
        self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>mouse_motion<span class="hl opt">) {</span>
        consumed <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_motion</span><span class="hl opt">(</span>self<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">);</span>
        <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// try all the other handlers in order of priority</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; !</span>consumed <span class="hl opt">&amp;&amp;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        
        <span class="hl kwa">if</span> <span class="hl opt">(</span>handler <span class="hl opt">!=</span> self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>mouse_motion<span class="hl opt">)</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_motion</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">))</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean 
<span class="hl kwd">on_scroll_notify</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventScroll <span class="hl opt">*</span>event<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwd">bot_gtk_gl_drawing_area_set_context</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">);</span>
    <span class="hl kwb">double</span> ray_start<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwb">double</span> ray_dir<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">];</span>
    <span class="hl kwd">_window_coord_to_ray</span> <span class="hl opt">(</span>event<span class="hl opt">-&gt;</span>x<span class="hl opt">,</span> widget<span class="hl opt">-&gt;</span>allocation<span class="hl opt">.</span>height <span class="hl opt">-</span> event<span class="hl opt">-&gt;</span>y<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">);</span>
    
    <span class="hl slc">// give picking handler first dibs</span>
    <span class="hl kwb">int</span> consumed <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp; !</span>self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">)</span>
        self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>mouse_scroll<span class="hl opt">) {</span>
        consumed <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_scroll</span><span class="hl opt">(</span>self<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">);</span>
        <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// try all the other handlers in order of priority</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; !</span>consumed <span class="hl opt">&amp;&amp;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        
        <span class="hl kwa">if</span> <span class="hl opt">(</span>handler <span class="hl opt">!=</span> self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>mouse_scroll<span class="hl opt">)</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>handler<span class="hl opt">-&gt;</span><span class="hl kwd">mouse_scroll</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> ray_start<span class="hl opt">,</span> ray_dir<span class="hl opt">,</span> event<span class="hl opt">))</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gint 
<span class="hl kwd">on_main_window_key_press_event</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventKey <span class="hl opt">*</span>event<span class="hl opt">,</span> 
                                <span class="hl kwb">void</span> <span class="hl opt">*</span>user<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user<span class="hl opt">;</span>

    <span class="hl slc">// give picking handler first dibs</span>
    <span class="hl kwb">int</span> consumed <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking <span class="hl opt">&amp;&amp;</span>
        self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>key_press<span class="hl opt">) {</span>
        consumed <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span><span class="hl kwd">key_press</span><span class="hl opt">(</span>self<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">,</span> event<span class="hl opt">);</span>
        <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// try all the other handlers in order of priority</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; !</span>consumed <span class="hl opt">&amp;&amp;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        
        <span class="hl kwa">if</span> <span class="hl opt">(</span>handler <span class="hl opt">!=</span> self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>key_press<span class="hl opt">) {</span>
            consumed <span class="hl opt">=</span> handler<span class="hl opt">-&gt;</span><span class="hl kwd">key_press</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> event<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>consumed<span class="hl opt">)</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> consumed<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gint 
<span class="hl kwd">on_main_window_key_release_event</span> <span class="hl opt">(</span>GtkWidget <span class="hl opt">*</span>widget<span class="hl opt">,</span> GdkEventKey <span class="hl opt">*</span>event<span class="hl opt">,</span> 
                                <span class="hl kwb">void</span> <span class="hl opt">*</span>user<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user<span class="hl opt">;</span>

    <span class="hl slc">// give picking handler first dibs</span>
    <span class="hl kwb">int</span> consumed <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking <span class="hl opt">&amp;&amp;</span>
        self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>key_release<span class="hl opt">) {</span>
        consumed <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span><span class="hl kwd">key_release</span><span class="hl opt">(</span>self<span class="hl opt">,</span> self<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">,</span> event<span class="hl opt">);</span>
        <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// try all the other handlers in order of priority</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; !</span>consumed <span class="hl opt">&amp;&amp;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>handler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        
        <span class="hl kwa">if</span> <span class="hl opt">(</span>handler <span class="hl opt">!=</span> self<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">&amp;&amp;</span> handler<span class="hl opt">-&gt;</span>key_release<span class="hl opt">) {</span>
            consumed <span class="hl opt">=</span> handler<span class="hl opt">-&gt;</span><span class="hl kwd">key_release</span><span class="hl opt">(</span>self<span class="hl opt">,</span> handler<span class="hl opt">,</span> event<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>consumed<span class="hl opt">)</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> consumed<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static int</span> 
<span class="hl kwd">_pixel_convert_8u_bgra_to_8u_rgb</span><span class="hl opt">(</span><span class="hl kwb">uint8_t</span> <span class="hl opt">*</span>dest<span class="hl opt">,</span> <span class="hl kwb">int</span> dstride<span class="hl opt">,</span> <span class="hl kwb">int</span> dwidth<span class="hl opt">,</span>
        <span class="hl kwb">int</span> dheight<span class="hl opt">,</span> <span class="hl kwb">const uint8_t</span> <span class="hl opt">*</span>src<span class="hl opt">,</span> <span class="hl kwb">int</span> sstride<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwb">int</span> i<span class="hl opt">,</span> j<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> dheight<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwb">uint8_t</span> <span class="hl opt">*</span> drow <span class="hl opt">=</span> dest <span class="hl opt">+</span> i <span class="hl opt">*</span> dstride<span class="hl opt">;</span>
        <span class="hl kwb">const uint8_t</span> <span class="hl opt">*</span> srow <span class="hl opt">=</span> src <span class="hl opt">+</span> i <span class="hl opt">*</span> sstride<span class="hl opt">;</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span>j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> j <span class="hl opt">&lt;</span> dwidth<span class="hl opt">;</span> j<span class="hl opt">++) {</span>
            drow<span class="hl opt">[</span>j<span class="hl opt">*</span><span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">] =</span> srow<span class="hl opt">[</span>j<span class="hl opt">*</span><span class="hl num">4</span> <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">];</span>
            drow<span class="hl opt">[</span>j<span class="hl opt">*</span><span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] =</span> srow<span class="hl opt">[</span>j<span class="hl opt">*</span><span class="hl num">4</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">];</span>
            drow<span class="hl opt">[</span>j<span class="hl opt">*</span><span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">] =</span> srow<span class="hl opt">[</span>j<span class="hl opt">*</span><span class="hl num">4</span> <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">];</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static</span> gboolean
<span class="hl kwd">take_screenshot</span> <span class="hl opt">(</span><span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">,</span> <span class="hl kwb">char</span> <span class="hl opt">*</span>fname<span class="hl opt">)</span>
<span class="hl opt">{</span>
 
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>
    BotViewHandler <span class="hl opt">*</span>vhandler <span class="hl opt">=</span> self<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">;</span>

    <span class="hl kwb">int</span> w <span class="hl opt">=</span> <span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">)-&gt;</span>allocation<span class="hl opt">.</span>width<span class="hl opt">;</span>
    <span class="hl kwb">int</span> h <span class="hl opt">=</span> <span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">)-&gt;</span>allocation<span class="hl opt">.</span>height<span class="hl opt">;</span>
    <span class="hl kwb">uint8_t</span> <span class="hl opt">*</span>bgra <span class="hl opt">= (</span><span class="hl kwb">uint8_t</span><span class="hl opt">*)</span><span class="hl kwd">malloc</span> <span class="hl opt">(</span>w<span class="hl opt">*</span>h<span class="hl opt">*</span><span class="hl num">4</span><span class="hl opt">);</span>
    <span class="hl kwb">uint8_t</span> <span class="hl opt">*</span>rgb <span class="hl opt">= (</span><span class="hl kwb">uint8_t</span><span class="hl opt">*)</span><span class="hl kwd">malloc</span> <span class="hl opt">(</span>w<span class="hl opt">*</span>h<span class="hl opt">*</span><span class="hl num">3</span><span class="hl opt">);</span>
    <span class="hl kwd">glReadPixels</span> <span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> w<span class="hl opt">,</span> h<span class="hl opt">,</span> GL_BGRA<span class="hl opt">,</span> GL_UNSIGNED_BYTE<span class="hl opt">,</span> bgra<span class="hl opt">);</span> 
    <span class="hl kwb">FILE</span> <span class="hl opt">*</span>fp <span class="hl opt">=</span> <span class="hl kwd">fopen</span> <span class="hl opt">(</span>fname<span class="hl opt">,</span> <span class="hl str">&quot;wb&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span> fp<span class="hl opt">) {</span>
        <span class="hl kwd">perror</span> <span class="hl opt">(</span><span class="hl str">&quot;fopen&quot;</span><span class="hl opt">);</span>
        <span class="hl kwd">err</span> <span class="hl opt">(</span><span class="hl str">&quot;couldn't take screenshot</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
        <span class="hl kwd">free</span> <span class="hl opt">(</span>bgra<span class="hl opt">);</span>
        <span class="hl kwd">free</span> <span class="hl opt">(</span>rgb<span class="hl opt">);</span>
        <span class="hl kwa">return</span> FALSE<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwd">_pixel_convert_8u_bgra_to_8u_rgb</span> <span class="hl opt">(</span>rgb<span class="hl opt">,</span> w<span class="hl opt">*</span><span class="hl num">3</span><span class="hl opt">,</span> w<span class="hl opt">,</span> h<span class="hl opt">,</span> bgra<span class="hl opt">,</span> w<span class="hl opt">*</span><span class="hl num">4</span><span class="hl opt">);</span>
        <span class="hl kwd">bot_ppm_write_bottom_up</span> <span class="hl opt">(</span>fp<span class="hl opt">,</span> rgb<span class="hl opt">,</span> w<span class="hl opt">,</span> h<span class="hl opt">,</span> w<span class="hl opt">*</span><span class="hl num">3</span><span class="hl opt">);</span>
        <span class="hl kwd">fclose</span> <span class="hl opt">(</span>fp<span class="hl opt">);</span>

        <span class="hl kwd">dbg</span> <span class="hl opt">(</span><span class="hl str">&quot;screenshot saved to %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">);</span>
        <span class="hl kwd">bot_viewer_set_status_bar_message</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> <span class="hl str">&quot;screenshot saved to %s&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">free</span> <span class="hl opt">(</span>bgra<span class="hl opt">);</span>
    <span class="hl kwd">free</span> <span class="hl opt">(</span>rgb<span class="hl opt">);</span>
    <span class="hl kwa">return</span> TRUE<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_screenshot_clicked</span> <span class="hl opt">(</span>GtkToolButton <span class="hl opt">*</span>ssbt<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwb">char</span> <span class="hl opt">*</span> fname <span class="hl opt">=</span> <span class="hl kwd">bot_fileutils_get_unique_filename</span> <span class="hl opt">(</span>NULL<span class="hl opt">,</span> <span class="hl str">&quot;viewer&quot;</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl str">&quot;ppm&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">take_screenshot</span> <span class="hl opt">(</span>user_data<span class="hl opt">,</span> fname<span class="hl opt">);</span>
    <span class="hl kwd">free</span> <span class="hl opt">(</span>fname<span class="hl opt">);</span>
<span class="hl opt">}</span>


<span class="hl com">/*</span>
<span class="hl com">static gboolean</span>
<span class="hl com">on_screenshot_timer (BotViewer * self)</span>
<span class="hl com">{</span>
<span class="hl com">    return take_screenshot (self, &quot;viewer.ppm&quot;);</span>
<span class="hl com">}</span>
<span class="hl com">*/</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_record_toggled</span> <span class="hl opt">(</span>GtkToggleToolButton <span class="hl opt">*</span>tb<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>
    <span class="hl kwb">int</span> record <span class="hl opt">=</span> <span class="hl kwd">gtk_toggle_tool_button_get_active</span> <span class="hl opt">(</span>tb<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>record <span class="hl opt">&amp;&amp; !</span> self<span class="hl opt">-&gt;</span>is_recording<span class="hl opt">) {</span>
        <span class="hl kwd">bot_viewer_start_recording</span> <span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwd">bot_viewer_stop_recording</span> <span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>


<span class="hl kwb">static void</span>
<span class="hl kwd">on_renderer_enabled_toggled</span> <span class="hl opt">(</span>GtkCheckMenuItem <span class="hl opt">*</span>cmi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>
    BotRenderer <span class="hl opt">*</span>r <span class="hl opt">= (</span>BotRenderer<span class="hl opt">*)</span> <span class="hl kwd">g_object_get_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>cmi<span class="hl opt">),</span> 
                                                 <span class="hl str">&quot;BotViewer:plugin&quot;</span><span class="hl opt">);</span>
    r<span class="hl opt">-&gt;</span>enabled <span class="hl opt">=</span> <span class="hl kwd">gtk_check_menu_item_get_active</span> <span class="hl opt">(</span>cmi<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>r<span class="hl opt">-&gt;</span>widget<span class="hl opt">) {</span>
        GtkWidget <span class="hl opt">*</span>frame <span class="hl opt">=</span> <span class="hl kwd">g_object_get_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>r<span class="hl opt">-&gt;</span>widget<span class="hl opt">),</span> 
                                              <span class="hl str">&quot;BotViewer:frame&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>frame<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>r<span class="hl opt">-&gt;</span>enabled<span class="hl opt">) {</span>
                <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>frame<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwd">gtk_widget_hide</span> <span class="hl opt">(</span>frame<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">bot_viewer_request_redraw</span> <span class="hl opt">(</span>self<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_event_handler_enabled_toggled</span> <span class="hl opt">(</span>GtkCheckMenuItem <span class="hl opt">*</span>cmi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>
    BotEventHandler <span class="hl opt">*</span>ehandler <span class="hl opt">= (</span>BotEventHandler<span class="hl opt">*)</span> <span class="hl kwd">g_object_get_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>cmi<span class="hl opt">),</span> <span class="hl str">&quot;BotViewer:plugin&quot;</span><span class="hl opt">);</span>

    ehandler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">=</span> <span class="hl kwd">gtk_check_menu_item_get_active</span> <span class="hl opt">(</span>cmi<span class="hl opt">);</span>

    <span class="hl kwd">bot_viewer_request_redraw</span> <span class="hl opt">(</span>self<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_select_all_event_handlers_activate</span> <span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>ehandler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        ehandler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl kwd">gtk_check_menu_item_set_active</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CHECK_MENU_ITEM</span><span class="hl opt">(</span>ehandler<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> ehandler<span class="hl opt">-&gt;</span>enabled<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_select_no_event_handlers_activate</span> <span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> eidx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> eidx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> eidx<span class="hl opt">++) {</span>
        BotEventHandler <span class="hl opt">*</span>ehandler <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> eidx<span class="hl opt">);</span>
        ehandler<span class="hl opt">-&gt;</span>enabled <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwd">gtk_check_menu_item_set_active</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CHECK_MENU_ITEM</span><span class="hl opt">(</span>ehandler<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> ehandler<span class="hl opt">-&gt;</span>enabled<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_select_all_renderers_activate</span> <span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> ridx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> ridx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> ridx<span class="hl opt">++) {</span>
        BotRenderer <span class="hl opt">*</span>renderer <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">,</span> ridx<span class="hl opt">);</span>

        renderer<span class="hl opt">-&gt;</span>enabled <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl kwd">gtk_check_menu_item_set_active</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CHECK_MENU_ITEM</span><span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>enabled<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_select_no_renderers_activate</span> <span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user_data<span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> ridx <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> ridx <span class="hl opt">&lt;</span> self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> ridx<span class="hl opt">++) {</span>
        BotRenderer <span class="hl opt">*</span>renderer <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">,</span> ridx<span class="hl opt">);</span>

        renderer<span class="hl opt">-&gt;</span>enabled <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwd">gtk_check_menu_item_set_active</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CHECK_MENU_ITEM</span><span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>enabled<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">on_renderer_widget_expander_notify</span> <span class="hl opt">(</span>GObject <span class="hl opt">*</span>object<span class="hl opt">,</span> GParamSpec <span class="hl opt">*</span>param_spec<span class="hl opt">,</span> 
        <span class="hl kwb">void</span> <span class="hl opt">*</span>user_data<span class="hl opt">)</span>
<span class="hl opt">{</span>
    GtkExpander <span class="hl opt">*</span>expander <span class="hl opt">=</span> <span class="hl kwd">GTK_EXPANDER</span> <span class="hl opt">(</span>object<span class="hl opt">);</span>
    BotRenderer <span class="hl opt">*</span>renderer <span class="hl opt">=</span> 
        <span class="hl opt">(</span>BotRenderer<span class="hl opt">*)</span> <span class="hl kwd">g_object_get_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>expander<span class="hl opt">),</span> <span class="hl str">&quot;BotViewer:plugin&quot;</span><span class="hl opt">);</span>

    renderer<span class="hl opt">-&gt;</span>expanded <span class="hl opt">=</span> <span class="hl kwd">gtk_expander_get_expanded</span> <span class="hl opt">(</span>expander<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>expanded<span class="hl opt">)</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">);</span>
    <span class="hl kwa">else</span>
        <span class="hl kwd">gtk_widget_hide</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span> <span class="hl kwd">on_select_bookmark_save_view</span><span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user<span class="hl opt">)</span>
<span class="hl opt">{</span>
  bookmark_persp_t <span class="hl opt">*</span>views <span class="hl opt">=</span> user<span class="hl opt">;</span>
  BotViewer<span class="hl opt">*</span> viewer <span class="hl opt">=</span> views<span class="hl opt">-&gt;</span>viewer<span class="hl opt">;</span>
  BotViewHandler <span class="hl opt">*</span>vhandler <span class="hl opt">=</span> viewer<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">;</span>

  BotDefaultViewHandler <span class="hl opt">*</span>dvh <span class="hl opt">= (</span>BotDefaultViewHandler<span class="hl opt">*)</span> vhandler<span class="hl opt">-&gt;</span>user<span class="hl opt">;</span>

  <span class="hl slc">// figure out projection mode  </span>
  views<span class="hl opt">-&gt;</span>projection_mode <span class="hl opt">=</span> vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">get_projection_mode</span><span class="hl opt">(</span>vhandler<span class="hl opt">);</span>

  views<span class="hl opt">-&gt;</span>saved <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
  vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">get_eye_look</span><span class="hl opt">(</span>vhandler<span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>eye<span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>lookat<span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>up<span class="hl opt">);</span>

  <span class="hl kwd">bot_viewer_set_status_bar_message</span><span class="hl opt">(</span>viewer<span class="hl opt">,</span> <span class="hl str">&quot;Saved viewpoint %d&quot;</span><span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>index<span class="hl opt">);</span>
<span class="hl opt">}</span>



<span class="hl kwb">static void</span> <span class="hl kwd">on_select_bookmark_load_view</span><span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user<span class="hl opt">)</span>
<span class="hl opt">{</span>
 
  bookmark_persp_t <span class="hl opt">*</span>views <span class="hl opt">=</span> user<span class="hl opt">;</span>
  BotViewer<span class="hl opt">*</span> viewer <span class="hl opt">=</span> views<span class="hl opt">-&gt;</span>viewer<span class="hl opt">;</span>
  BotViewHandler <span class="hl opt">*</span>vhandler <span class="hl opt">=</span> viewer<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">;</span>

  <span class="hl slc">//HARDCODE: duration of smooth transition</span>
  <span class="hl kwb">int</span> duration_ms <span class="hl opt">=</span> <span class="hl num">500</span><span class="hl opt">;</span>  <span class="hl slc">//milliseconds</span>

  <span class="hl kwa">if</span><span class="hl opt">(</span>views<span class="hl opt">-&gt;</span>saved<span class="hl opt">) {</span>
    <span class="hl slc">// get projection type</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>views<span class="hl opt">-&gt;</span>projection_mode <span class="hl opt">==</span> BOT_VIEW_ORTHOGRAPHIC<span class="hl opt">)</span>
      vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">set_camera_orthographic</span><span class="hl opt">(</span>vhandler<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>views<span class="hl opt">-&gt;</span>projection_mode <span class="hl opt">==</span> BOT_VIEW_PERSPECTIVE<span class="hl opt">)</span>
      vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">set_camera_perspective</span><span class="hl opt">(</span>vhandler<span class="hl opt">,</span> vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">get_perspective_fov</span><span class="hl opt">(</span>vhandler<span class="hl opt">));</span>

    vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">set_look_at_smooth</span><span class="hl opt">(</span>vhandler<span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>eye<span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>lookat<span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>up<span class="hl opt">,</span> duration_ms<span class="hl opt">);</span>
    <span class="hl kwd">bot_viewer_request_redraw</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>

    <span class="hl kwd">bot_viewer_set_status_bar_message</span><span class="hl opt">(</span>viewer<span class="hl opt">,</span> <span class="hl str">&quot;Loaded viewpoint %d&quot;</span><span class="hl opt">,</span> views<span class="hl opt">-&gt;</span>index<span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span> <span class="hl kwd">on_select_perspective_item</span><span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user<span class="hl opt">)</span>
<span class="hl opt">{</span>
  BotViewer<span class="hl opt">*</span> viewer <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user<span class="hl opt">;</span>
  BotViewHandler <span class="hl opt">*</span>vhandler <span class="hl opt">=</span> viewer<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>vhandler<span class="hl opt">) {</span>
    vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">set_camera_perspective</span><span class="hl opt">(</span>vhandler<span class="hl opt">,</span> <span class="hl num">60</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span> <span class="hl kwd">on_select_orthographic_item</span><span class="hl opt">(</span>GtkMenuItem <span class="hl opt">*</span>mi<span class="hl opt">,</span> <span class="hl kwb">void</span> <span class="hl opt">*</span>user<span class="hl opt">)</span>
<span class="hl opt">{</span>
  BotViewer<span class="hl opt">*</span> viewer <span class="hl opt">= (</span>BotViewer<span class="hl opt">*)</span> user<span class="hl opt">;</span>
  BotViewHandler <span class="hl opt">*</span>vhandler <span class="hl opt">=</span> viewer<span class="hl opt">-&gt;</span>view_handler<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>vhandler<span class="hl opt">) {</span>
    vhandler<span class="hl opt">-&gt;</span><span class="hl kwd">set_camera_orthographic</span><span class="hl opt">(</span>vhandler<span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>



<span class="hl slc">// ================</span>

<span class="hl kwb">static</span> gint <span class="hl kwd">renderer_name_compare_function</span><span class="hl opt">(</span>gconstpointer _a<span class="hl opt">,</span> gconstpointer _b<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotRenderer <span class="hl opt">*</span>ra <span class="hl opt">= *(</span>BotRenderer<span class="hl opt">**)</span> _a<span class="hl opt">;</span>
    BotRenderer <span class="hl opt">*</span>rb <span class="hl opt">= *(</span>BotRenderer<span class="hl opt">**)</span> _b<span class="hl opt">;</span>

    <span class="hl kwa">return</span> <span class="hl kwd">strcmp</span><span class="hl opt">(</span>ra<span class="hl opt">-&gt;</span>name<span class="hl opt">,</span> rb<span class="hl opt">-&gt;</span>name<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl slc">// sort in decending order of priority</span>
<span class="hl kwb">static</span> gint <span class="hl kwd">sort_renderers_priority_decreasing</span><span class="hl opt">(</span>gconstpointer _a<span class="hl opt">,</span> gconstpointer _b<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotRenderer <span class="hl opt">*</span>a <span class="hl opt">= *(</span>BotRenderer<span class="hl opt">**)</span> _a<span class="hl opt">;</span>
    BotRenderer <span class="hl opt">*</span>b <span class="hl opt">= *(</span>BotRenderer<span class="hl opt">**)</span> _b<span class="hl opt">;</span>

    <span class="hl kwa">return</span> <span class="hl opt">(</span>a<span class="hl opt">-&gt;</span>priority <span class="hl opt">&lt;</span> b<span class="hl opt">-&gt;</span>priority<span class="hl opt">)</span> ? <span class="hl num">1</span> <span class="hl opt">: -</span><span class="hl num">1</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">static int</span> <span class="hl kwd">_g_ptr_array_find_index</span><span class="hl opt">(</span>GPtrArray <span class="hl opt">*</span>a<span class="hl opt">,</span> gconstpointer v<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">unsigned int</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> a<span class="hl opt">-&gt;</span>len<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">g_ptr_array_index</span><span class="hl opt">(</span>a<span class="hl opt">,</span> i<span class="hl opt">) ==</span> v<span class="hl opt">)</span>
            <span class="hl kwa">return</span> i<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">;</span>
<span class="hl opt">}</span>



<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_add_renderer_on_side</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>self<span class="hl opt">,</span> BotRenderer <span class="hl opt">*</span>renderer<span class="hl opt">,</span> <span class="hl kwb">int</span> priority<span class="hl opt">,</span> <span class="hl kwb">int</span> which_side<span class="hl opt">)</span>
<span class="hl opt">{</span>
    renderer<span class="hl opt">-&gt;</span>priority <span class="hl opt">=</span> priority<span class="hl opt">;</span>
    renderer<span class="hl opt">-&gt;</span>cmi      <span class="hl opt">=</span> <span class="hl kwd">gtk_check_menu_item_new_with_label</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">);</span>
    <span class="hl kwd">gtk_check_menu_item_set_active</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CHECK_MENU_ITEM</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>enabled<span class="hl opt">);</span>

    <span class="hl kwd">g_object_set_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> <span class="hl str">&quot;BotViewer:plugin&quot;</span><span class="hl opt">,</span> renderer<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> <span class="hl str">&quot;toggled&quot;</span><span class="hl opt">,</span> 
                      <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_renderer_enabled_toggled<span class="hl opt">),</span> self<span class="hl opt">);</span>
    
    <span class="hl kwd">g_ptr_array_add</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">,</span> renderer<span class="hl opt">);</span>
    <span class="hl kwd">g_ptr_array_add</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers_sorted<span class="hl opt">,</span> renderer<span class="hl opt">);</span>
    <span class="hl kwd">g_ptr_array_sort</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers_sorted<span class="hl opt">,</span> renderer_name_compare_function<span class="hl opt">);</span>

    <span class="hl slc">// What position in the sorted array is this item?</span>
    <span class="hl kwb">unsigned int</span> menu_idx <span class="hl opt">=</span> <span class="hl kwd">_g_ptr_array_find_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers_sorted<span class="hl opt">,</span> renderer<span class="hl opt">);</span>

    <span class="hl slc">// add the menu item, accounting for the tear-off tab at index 0</span>
    <span class="hl kwd">gtk_menu_shell_insert</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU_SHELL</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers_menu<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">,</span> menu_idx <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>cmi<span class="hl opt">);</span>

    <span class="hl slc">// create a control widget</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">) {</span>
        <span class="hl kwd">g_ptr_array_add</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers_sorted_with_controls<span class="hl opt">,</span> renderer<span class="hl opt">);</span>
        <span class="hl kwd">g_ptr_array_sort</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers_sorted_with_controls<span class="hl opt">,</span> renderer_name_compare_function<span class="hl opt">);</span>

        <span class="hl kwb">unsigned int</span> control_idx <span class="hl opt">=</span> <span class="hl kwd">_g_ptr_array_find_index</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers_sorted_with_controls<span class="hl opt">,</span> renderer<span class="hl opt">);</span>

        renderer<span class="hl opt">-&gt;</span>expander <span class="hl opt">=</span> <span class="hl kwd">gtk_expander_new</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>name<span class="hl opt">);</span>
        <span class="hl kwd">gtk_expander_set_expanded</span> <span class="hl opt">(</span><span class="hl kwd">GTK_EXPANDER</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>expander<span class="hl opt">),</span> TRUE<span class="hl opt">);</span>
        renderer<span class="hl opt">-&gt;</span>control_frame <span class="hl opt">=</span> <span class="hl kwd">gtk_frame_new</span> <span class="hl opt">(</span>NULL<span class="hl opt">);</span>
        
        <span class="hl kwa">if</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>enabled<span class="hl opt">) {</span>
            <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwd">gtk_widget_hide</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        
        <span class="hl kwd">gtk_frame_set_label_widget</span> <span class="hl opt">(</span><span class="hl kwd">GTK_FRAME</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>expander<span class="hl opt">);</span>
        <span class="hl kwd">gtk_container_add</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">);</span>
        
<span class="hl ppc">#ifdef CONTROLS_BOX_LEFT_ENABLED</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>which_side<span class="hl opt">==</span><span class="hl num">0</span><span class="hl opt">){</span>
           <span class="hl kwd">gtk_box_pack_start</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>controls_box_left<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">,</span>
                            FALSE<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
           <span class="hl kwd">gtk_box_reorder_child</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>controls_box_left<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">,</span> control_idx<span class="hl opt">);</span>
        <span class="hl opt">}</span><span class="hl kwa">else</span><span class="hl opt">{</span> <span class="hl slc">// new dec 2012:</span>
           <span class="hl slc">// Add your controls to the left hand side of the viewer - instead of the default:</span>
           <span class="hl kwd">gtk_box_pack_start</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>controls_box<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">,</span>
                            FALSE<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
           <span class="hl kwd">gtk_box_reorder_child</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>controls_box<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">,</span> control_idx<span class="hl opt">);</span>
        <span class="hl opt">}</span>
<span class="hl ppc">#else</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>which_side <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span>
            <span class="hl kwd">fprintf</span> <span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Left-side renderer support disabled</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>

        <span class="hl kwd">gtk_box_pack_start</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>controls_box<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">,</span>
                            FALSE<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
        <span class="hl kwd">gtk_box_reorder_child</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>controls_box<span class="hl opt">),</span> renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">,</span> control_idx<span class="hl opt">);</span>
<span class="hl ppc">#endif</span>

        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>expander<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">);</span>
        
        <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>expander<span class="hl opt">),</span> <span class="hl str">&quot;notify::expanded&quot;</span><span class="hl opt">,</span>
                          <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_renderer_widget_expander_notify<span class="hl opt">),</span> self<span class="hl opt">);</span>
        <span class="hl kwd">g_object_set_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>expander<span class="hl opt">),</span> 
                           <span class="hl str">&quot;BotViewer:plugin&quot;</span><span class="hl opt">,</span> renderer<span class="hl opt">);</span>
        <span class="hl kwd">g_object_set_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">),</span> 
                           <span class="hl str">&quot;BotViewer:expander&quot;</span><span class="hl opt">,</span> renderer<span class="hl opt">-&gt;</span>expander<span class="hl opt">);</span>
        <span class="hl kwd">g_object_set_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>renderer<span class="hl opt">-&gt;</span>widget<span class="hl opt">),</span> 
                           <span class="hl str">&quot;BotViewer:frame&quot;</span><span class="hl opt">,</span> renderer<span class="hl opt">-&gt;</span>control_frame<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwd">g_ptr_array_sort</span><span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>renderers<span class="hl opt">,</span> sort_renderers_priority_decreasing<span class="hl opt">);</span>
<span class="hl opt">}</span>


<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_add_renderer</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>self<span class="hl opt">,</span> BotRenderer <span class="hl opt">*</span>renderer<span class="hl opt">,</span> <span class="hl kwb">int</span> priority<span class="hl opt">){</span>
    <span class="hl kwa">return</span> <span class="hl kwd">bot_viewer_add_renderer_on_side</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> renderer<span class="hl opt">,</span> priority<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
<span class="hl opt">}</span>




<span class="hl com">/*</span>
<span class="hl com">static void</span>
<span class="hl com">destroy_plugins (BotViewer *self)</span>
<span class="hl com">{</span>
<span class="hl com">    for (unsigned int ridx = 0; ridx &lt; g_ptr_array_size(self-&gt;renderers); ridx++) {</span>
<span class="hl com">        BotRenderer *renderer = g_ptr_array_index(self-&gt;renderers, ridx);</span>
<span class="hl com"></span>
<span class="hl com">        if (renderer-&gt;destroy)</span>
<span class="hl com">            renderer-&gt;destroy(renderer);</span>
<span class="hl com">    }</span>
<span class="hl com"></span>
<span class="hl com">    g_ptr_array_free(self-&gt;plugins, TRUE);</span>
<span class="hl com">}</span>
<span class="hl com">*/</span>

<span class="hl kwb">static void</span> 
<span class="hl kwd">make_menus</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> GtkWidget <span class="hl opt">*</span>parent<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewerPriv<span class="hl opt">*</span> priv <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER_GET_PRIVATE</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span>menubar <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_bar_new</span><span class="hl opt">();</span>
    viewer<span class="hl opt">-&gt;</span>menu_bar <span class="hl opt">=</span> menubar<span class="hl opt">;</span>

    <span class="hl kwd">gtk_box_pack_start</span><span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span><span class="hl opt">(</span>parent<span class="hl opt">),</span> menubar<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
    
    GtkWidget <span class="hl opt">*</span>file_menuitem <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span><span class="hl opt">(</span><span class="hl str">&quot;_File&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_menu_bar_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_BAR</span><span class="hl opt">(</span>menubar<span class="hl opt">),</span> file_menuitem<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>file_menu <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_menu_item_set_submenu</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_ITEM</span><span class="hl opt">(</span>file_menuitem<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>file_menu<span class="hl opt">);</span>

    <span class="hl slc">/////////////////////</span>
    GtkWidget <span class="hl opt">*</span>renderers_menuitem <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span><span class="hl opt">(</span><span class="hl str">&quot;_BotRenderers&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_menu_bar_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_BAR</span><span class="hl opt">(</span>menubar<span class="hl opt">),</span> renderers_menuitem<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>renderers_menu <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_menu_item_set_submenu</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_ITEM</span><span class="hl opt">(</span>renderers_menuitem<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>renderers_menu<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl slc">// tearoff</span>
        GtkWidget <span class="hl opt">*</span>tearoff <span class="hl opt">=</span> <span class="hl kwd">gtk_tearoff_menu_item_new</span><span class="hl opt">();</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>renderers_menu<span class="hl opt">),</span> tearoff<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>tearoff<span class="hl opt">);</span>

        <span class="hl slc">// separator</span>
        GtkWidget <span class="hl opt">*</span>sep <span class="hl opt">=</span> <span class="hl kwd">gtk_separator_menu_item_new</span> <span class="hl opt">();</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>renderers_menu<span class="hl opt">),</span> sep<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>sep<span class="hl opt">);</span>

        <span class="hl slc">// select all item</span>
        GtkWidget <span class="hl opt">*</span>select_all_mi <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span> <span class="hl opt">(</span><span class="hl str">&quot;Select _All&quot;</span><span class="hl opt">);</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>renderers_menu<span class="hl opt">),</span> select_all_mi<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>select_all_mi<span class="hl opt">);</span>
        
        <span class="hl slc">// remove all item</span>
        GtkWidget <span class="hl opt">*</span>select_none_mi <span class="hl opt">=</span> 
            <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span> <span class="hl opt">(</span><span class="hl str">&quot;Select _None&quot;</span><span class="hl opt">);</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>renderers_menu<span class="hl opt">),</span> select_none_mi<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>select_none_mi<span class="hl opt">);</span>
        <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>select_all_mi<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> 
                          <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_select_all_renderers_activate<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
        <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>select_none_mi<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span>
                          <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_select_no_renderers_activate<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">/////////////////////</span>
    GtkWidget <span class="hl opt">*</span>event_handlers_menuitem <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span><span class="hl opt">(</span><span class="hl str">&quot;_Input&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_menu_bar_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_BAR</span><span class="hl opt">(</span>menubar<span class="hl opt">),</span> event_handlers_menuitem<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>event_handlers_menu <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_menu_item_set_submenu</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_ITEM</span><span class="hl opt">(</span>event_handlers_menuitem<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>event_handlers_menu<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl slc">// tearoff</span>
        GtkWidget <span class="hl opt">*</span>tearoff <span class="hl opt">=</span> <span class="hl kwd">gtk_tearoff_menu_item_new</span><span class="hl opt">();</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_menu<span class="hl opt">),</span> tearoff<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>tearoff<span class="hl opt">);</span>

        <span class="hl slc">// separator</span>
        GtkWidget <span class="hl opt">*</span>sep <span class="hl opt">=</span> <span class="hl kwd">gtk_separator_menu_item_new</span> <span class="hl opt">();</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_menu<span class="hl opt">),</span> sep<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>sep<span class="hl opt">);</span>

        <span class="hl slc">// select all item</span>
        GtkWidget <span class="hl opt">*</span>select_all_mi <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span> <span class="hl opt">(</span><span class="hl str">&quot;Select _All&quot;</span><span class="hl opt">);</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_menu<span class="hl opt">),</span> select_all_mi<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>select_all_mi<span class="hl opt">);</span>
        
        <span class="hl slc">// remove all item</span>
        GtkWidget <span class="hl opt">*</span>select_none_mi <span class="hl opt">=</span> 
            <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span> <span class="hl opt">(</span><span class="hl str">&quot;Select _None&quot;</span><span class="hl opt">);</span>
        <span class="hl kwd">gtk_menu_append</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_menu<span class="hl opt">),</span> select_none_mi<span class="hl opt">);</span>
        <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>select_none_mi<span class="hl opt">);</span>
        <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>select_all_mi<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> 
                          <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_select_all_event_handlers_activate<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
        <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>select_none_mi<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span>
                          <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_select_no_event_handlers_activate<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl opt">}</span>


    <span class="hl slc">//add perspective and orthographic controls...</span>
    GtkWidget <span class="hl opt">*</span>view_menuitem <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_mnemonic</span><span class="hl opt">(</span><span class="hl str">&quot;_View&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_menu_bar_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_BAR</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>menu_bar<span class="hl opt">),</span> view_menuitem<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>view_menu <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_menu_item_set_submenu</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_ITEM</span><span class="hl opt">(</span>view_menuitem<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>view_menu<span class="hl opt">);</span>

    GSList <span class="hl opt">*</span>view_list <span class="hl opt">=</span> NULL<span class="hl opt">;</span>
    GtkWidget <span class="hl opt">*</span>perspective_item <span class="hl opt">=</span> <span class="hl kwd">gtk_radio_menu_item_new_with_label</span><span class="hl opt">(</span>view_list<span class="hl opt">,</span> <span class="hl str">&quot;Perspective&quot;</span><span class="hl opt">);</span>
    view_list <span class="hl opt">=</span> <span class="hl kwd">gtk_radio_menu_item_get_group</span><span class="hl opt">(</span><span class="hl kwd">GTK_RADIO_MENU_ITEM</span><span class="hl opt">(</span>perspective_item<span class="hl opt">));</span>
    <span class="hl kwd">gtk_menu_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>view_menu<span class="hl opt">),</span> perspective_item<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span><span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>perspective_item<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> <span class="hl kwd">G_CALLBACK</span><span class="hl opt">(</span>on_select_perspective_item<span class="hl opt">),</span> viewer<span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span>orthographic_item <span class="hl opt">=</span> <span class="hl kwd">gtk_radio_menu_item_new_with_label</span><span class="hl opt">(</span>view_list<span class="hl opt">,</span> <span class="hl str">&quot;Orthographic&quot;</span><span class="hl opt">);</span>
    view_list <span class="hl opt">=</span> <span class="hl kwd">gtk_radio_menu_item_get_group</span><span class="hl opt">(</span><span class="hl kwd">GTK_RADIO_MENU_ITEM</span><span class="hl opt">(</span>orthographic_item<span class="hl opt">));</span>
    <span class="hl kwd">gtk_menu_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>view_menu<span class="hl opt">),</span> orthographic_item<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span><span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>orthographic_item<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> <span class="hl kwd">G_CALLBACK</span><span class="hl opt">(</span>on_select_orthographic_item<span class="hl opt">),</span> viewer<span class="hl opt">);</span>

    <span class="hl slc">// create labels for loading and saving bookmarked views</span>
    guint keys<span class="hl opt">[] = {</span>
        GDK_F1<span class="hl opt">,</span>
        GDK_F2<span class="hl opt">,</span>
        GDK_F3<span class="hl opt">,</span>
        GDK_F4<span class="hl opt">,</span>
        GDK_F5<span class="hl opt">,</span>
        GDK_F6<span class="hl opt">,</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwb">int</span> i<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">&lt;</span>priv<span class="hl opt">-&gt;</span>num_bookmarks<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwb">char</span><span class="hl opt">*</span> smi_label <span class="hl opt">=</span> <span class="hl kwd">g_strdup_printf</span><span class="hl opt">(</span><span class="hl str">&quot;Viewpoint %d&quot;</span><span class="hl opt">,</span> i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
      GtkWidget<span class="hl opt">*</span> submenu_item <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_label</span><span class="hl opt">(</span>smi_label<span class="hl opt">);</span>
      <span class="hl kwd">gtk_menu_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>view_menu<span class="hl opt">),</span> submenu_item<span class="hl opt">);</span>
      <span class="hl kwd">g_free</span><span class="hl opt">(</span>smi_label<span class="hl opt">);</span>

      GtkWidget<span class="hl opt">*</span> submenu <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_new</span><span class="hl opt">();</span>
      <span class="hl kwd">gtk_menu_item_set_submenu</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU_ITEM</span><span class="hl opt">(</span>submenu_item<span class="hl opt">),</span> submenu<span class="hl opt">);</span>
      GtkWidget<span class="hl opt">*</span> save_smi <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_label</span><span class="hl opt">(</span><span class="hl str">&quot;Save&quot;</span><span class="hl opt">);</span>
      GtkWidget<span class="hl opt">*</span> load_smi <span class="hl opt">=</span> <span class="hl kwd">gtk_menu_item_new_with_label</span><span class="hl opt">(</span><span class="hl str">&quot;Load&quot;</span><span class="hl opt">);</span>
      <span class="hl kwd">gtk_menu_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>submenu<span class="hl opt">),</span> save_smi<span class="hl opt">);</span>
      <span class="hl kwd">gtk_menu_append</span><span class="hl opt">(</span><span class="hl kwd">GTK_MENU</span><span class="hl opt">(</span>submenu<span class="hl opt">),</span> load_smi<span class="hl opt">);</span>
      <span class="hl kwd">g_signal_connect</span><span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>save_smi<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> 
              <span class="hl kwd">G_CALLBACK</span><span class="hl opt">(</span>on_select_bookmark_save_view<span class="hl opt">), &amp;</span>priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>i<span class="hl opt">]);</span>
      <span class="hl kwd">g_signal_connect</span><span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>load_smi<span class="hl opt">),</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> 
              <span class="hl kwd">G_CALLBACK</span><span class="hl opt">(</span>on_select_bookmark_load_view<span class="hl opt">), &amp;</span>priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>i<span class="hl opt">]);</span>

      <span class="hl kwd">gtk_widget_add_accelerator</span><span class="hl opt">(</span>save_smi<span class="hl opt">,</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> priv<span class="hl opt">-&gt;</span>key_accel_group<span class="hl opt">,</span>
              keys<span class="hl opt">[</span>i<span class="hl opt">],</span> GDK_CONTROL_MASK<span class="hl opt">,</span> GTK_ACCEL_VISIBLE<span class="hl opt">);</span>
      <span class="hl kwd">gtk_widget_add_accelerator</span><span class="hl opt">(</span>load_smi<span class="hl opt">,</span> <span class="hl str">&quot;activate&quot;</span><span class="hl opt">,</span> priv<span class="hl opt">-&gt;</span>key_accel_group<span class="hl opt">,</span>
              keys<span class="hl opt">[</span>i<span class="hl opt">],</span> <span class="hl num">0</span><span class="hl opt">,</span> GTK_ACCEL_VISIBLE<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwd">gtk_widget_show_all</span><span class="hl opt">(</span>view_menuitem<span class="hl opt">);</span>


<span class="hl opt">}</span>

<span class="hl kwb">static void</span> 
<span class="hl kwd">make_toolbar</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> GtkWidget <span class="hl opt">*</span>parent<span class="hl opt">)</span>
<span class="hl opt">{</span>
    GtkWidget <span class="hl opt">*</span>toolbar <span class="hl opt">=</span> <span class="hl kwd">gtk_toolbar_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_box_pack_start</span><span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span><span class="hl opt">(</span>parent<span class="hl opt">),</span> toolbar<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>

    <span class="hl slc">// add a recording button to the toolbar</span>
    viewer<span class="hl opt">-&gt;</span>record_button <span class="hl opt">=</span> <span class="hl kwd">GTK_WIDGET</span><span class="hl opt">(</span>
        <span class="hl kwd">gtk_toggle_tool_button_new_from_stock</span> <span class="hl opt">(</span>GTK_STOCK_MEDIA_RECORD<span class="hl opt">));</span>
    <span class="hl kwd">gtk_tool_item_set_is_important</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOL_ITEM</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>record_button<span class="hl opt">),</span> 
            TRUE<span class="hl opt">);</span>
    <span class="hl kwd">gtk_tool_item_set_tooltip</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOL_ITEM</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>record_button<span class="hl opt">),</span> 
            viewer<span class="hl opt">-&gt;</span>tips<span class="hl opt">,</span>
            <span class="hl str">&quot;Record an AVI of the viewport, saved in the current directory&quot;</span><span class="hl opt">,</span>
            NULL<span class="hl opt">);</span>

    <span class="hl kwd">gtk_toolbar_insert</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOLBAR</span> <span class="hl opt">(</span>toolbar<span class="hl opt">),</span> 
            <span class="hl kwd">GTK_TOOL_ITEM</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>record_button<span class="hl opt">),</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>record_button<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>record_button<span class="hl opt">),</span> <span class="hl str">&quot;toggled&quot;</span><span class="hl opt">,</span> 
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_record_toggled<span class="hl opt">),</span> viewer<span class="hl opt">);</span>

    <span class="hl slc">// screenshot button</span>
    GtkToolItem <span class="hl opt">*</span>ssbt <span class="hl opt">=</span> <span class="hl kwd">gtk_tool_button_new_from_stock</span> <span class="hl opt">(</span>GTK_STOCK_FLOPPY<span class="hl opt">);</span>
    <span class="hl kwd">gtk_tool_button_set_label</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOL_BUTTON</span> <span class="hl opt">(</span>ssbt<span class="hl opt">),</span> <span class="hl str">&quot;Screenshot&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_tool_item_set_is_important</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOL_ITEM</span> <span class="hl opt">(</span>ssbt<span class="hl opt">),</span> TRUE<span class="hl opt">);</span>
    <span class="hl kwd">gtk_tool_item_set_tooltip</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOL_ITEM</span> <span class="hl opt">(</span>ssbt<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>tips<span class="hl opt">,</span>
            <span class="hl str">&quot;Save a PPM screenshot of the viewport to the current directory&quot;</span><span class="hl opt">,</span>
            NULL<span class="hl opt">);</span>
    <span class="hl kwd">gtk_toolbar_insert</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOLBAR</span> <span class="hl opt">(</span>toolbar<span class="hl opt">),</span> ssbt<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span><span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>ssbt<span class="hl opt">));</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>ssbt<span class="hl opt">),</span> <span class="hl str">&quot;clicked&quot;</span><span class="hl opt">,</span> 
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_screenshot_clicked<span class="hl opt">),</span> viewer<span class="hl opt">);</span>

    <span class="hl slc">// quit button</span>
    GtkToolItem <span class="hl opt">*</span>quitbt <span class="hl opt">=</span> <span class="hl kwd">gtk_tool_button_new_from_stock</span> <span class="hl opt">(</span>GTK_STOCK_QUIT<span class="hl opt">);</span>
    <span class="hl kwd">gtk_tool_item_set_tooltip</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOL_ITEM</span> <span class="hl opt">(</span>quitbt<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>tips<span class="hl opt">,</span>
            <span class="hl str">&quot;Quit&quot;</span><span class="hl opt">,</span> NULL<span class="hl opt">);</span>
    <span class="hl kwd">gtk_toolbar_insert</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOLBAR</span> <span class="hl opt">(</span>toolbar<span class="hl opt">),</span> quitbt<span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span><span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>quitbt<span class="hl opt">));</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>quitbt<span class="hl opt">),</span> <span class="hl str">&quot;clicked&quot;</span><span class="hl opt">,</span> gtk_main_quit<span class="hl opt">,</span> NULL<span class="hl opt">);</span>

    GtkToolItem <span class="hl opt">*</span> sep <span class="hl opt">=</span> <span class="hl kwd">gtk_separator_tool_item_new</span> <span class="hl opt">();</span>
    <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span><span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>sep<span class="hl opt">));</span>
    <span class="hl kwd">gtk_toolbar_insert</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOLBAR</span> <span class="hl opt">(</span>toolbar<span class="hl opt">),</span> sep<span class="hl opt">,</span> <span class="hl num">3</span><span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span> hbox <span class="hl opt">=</span> <span class="hl kwd">gtk_hbox_new</span> <span class="hl opt">(</span>FALSE<span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">);</span>
    GtkWidget <span class="hl opt">*</span> label <span class="hl opt">=</span> <span class="hl kwd">gtk_label_new</span> <span class="hl opt">(</span><span class="hl str">&quot;Record FPS&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_box_pack_start</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>hbox<span class="hl opt">),</span> label<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
    viewer<span class="hl opt">-&gt;</span>fps_spin <span class="hl opt">=</span> <span class="hl kwd">gtk_spin_button_new_with_range</span> <span class="hl opt">(</span><span class="hl num">0.1</span><span class="hl opt">,</span> <span class="hl num">120.0</span><span class="hl opt">,</span> <span class="hl num">1.0</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_spin_button_set_digits</span> <span class="hl opt">(</span><span class="hl kwd">GTK_SPIN_BUTTON</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>fps_spin<span class="hl opt">),</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_spin_button_set_value</span> <span class="hl opt">(</span><span class="hl kwd">GTK_SPIN_BUTTON</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>fps_spin<span class="hl opt">),</span> <span class="hl num">30</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_box_pack_start</span> <span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span> <span class="hl opt">(</span>hbox<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>fps_spin<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>

    GtkToolItem <span class="hl opt">*</span> toolitem <span class="hl opt">=</span> <span class="hl kwd">gtk_tool_item_new</span> <span class="hl opt">();</span>
    <span class="hl kwd">gtk_container_add</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span> <span class="hl opt">(</span>toolitem<span class="hl opt">),</span> hbox<span class="hl opt">);</span>
    <span class="hl kwd">gtk_widget_show_all</span> <span class="hl opt">(</span><span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>toolitem<span class="hl opt">));</span>
    <span class="hl kwd">gtk_toolbar_insert</span> <span class="hl opt">(</span><span class="hl kwd">GTK_TOOLBAR</span> <span class="hl opt">(</span>toolbar<span class="hl opt">),</span> toolitem<span class="hl opt">,</span> <span class="hl num">4</span><span class="hl opt">);</span>
    viewer<span class="hl opt">-&gt;</span>toolbar <span class="hl opt">=</span> <span class="hl kwd">GTK_TOOLBAR</span> <span class="hl opt">(</span>toolbar<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span> <span class="hl kwd">bot_viewer_class_init</span> <span class="hl opt">(</span>BotViewerClass <span class="hl opt">*</span>klass<span class="hl opt">);</span>

<span class="hl kwd">G_DEFINE_TYPE</span> <span class="hl opt">(</span>BotViewer<span class="hl opt">,</span> bot_viewer<span class="hl opt">,</span> G_TYPE_OBJECT<span class="hl opt">);</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">bot_viewer_finalize</span> <span class="hl opt">(</span>GObject <span class="hl opt">*</span>obj<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>self <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER</span> <span class="hl opt">(</span>obj<span class="hl opt">);</span>
    <span class="hl kwd">dbg</span> <span class="hl opt">(</span><span class="hl str">&quot;%s:%d %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> __FILE__<span class="hl opt">,</span> __LINE__<span class="hl opt">,</span> __FUNCTION__<span class="hl opt">);</span>

    BotViewerPriv<span class="hl opt">*</span> priv <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER_GET_PRIVATE</span><span class="hl opt">(</span>self<span class="hl opt">);</span>
    <span class="hl kwd">free</span><span class="hl opt">(</span>priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">);</span>

    <span class="hl kwd">gtk_widget_destroy</span> <span class="hl opt">(</span><span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>self<span class="hl opt">-&gt;</span>window<span class="hl opt">));</span>

    <span class="hl kwd">G_OBJECT_CLASS</span> <span class="hl opt">(</span>bot_viewer_parent_class<span class="hl opt">)-&gt;</span><span class="hl kwd">finalize</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">bot_viewer_class_init</span> <span class="hl opt">(</span>BotViewerClass <span class="hl opt">*</span>klass<span class="hl opt">)</span>
<span class="hl opt">{</span>
    GObjectClass <span class="hl opt">*</span>gobject_class <span class="hl opt">=</span> <span class="hl kwd">G_OBJECT_CLASS</span><span class="hl opt">(</span>klass<span class="hl opt">);</span>
    gobject_class<span class="hl opt">-&gt;</span>finalize <span class="hl opt">=</span> bot_viewer_finalize<span class="hl opt">;</span>
    <span class="hl com">/**</span>
<span class="hl com">     * BotViewer::load-preferences</span>
<span class="hl com">     * &#64;keyfile: a GKeyFile* to be used for loading saved preferences</span>
<span class="hl com">     *</span>
<span class="hl com">     * The load-preferences signal is emitted when bot_viewer_load_preferences is</span>
<span class="hl com">     * called on the viewer.  Objects can subscribe to this signal to load data</span>
<span class="hl com">     * from the GKeyFile.</span>
<span class="hl com">     */</span>
    bot_viewer_signals<span class="hl opt">[</span>LOAD_PREFERENCES_SIGNAL<span class="hl opt">] =</span> <span class="hl kwd">g_signal_new</span><span class="hl opt">(</span><span class="hl str">&quot;load-preferences&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_TYPE_FROM_CLASS</span><span class="hl opt">(</span>klass<span class="hl opt">),</span>
            G_SIGNAL_RUN_FIRST<span class="hl opt">,</span>
            <span class="hl num">0</span><span class="hl opt">,</span> NULL<span class="hl opt">,</span> NULL<span class="hl opt">,</span> g_cclosure_marshal_VOID__POINTER<span class="hl opt">,</span>
            G_TYPE_NONE<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> G_TYPE_POINTER<span class="hl opt">);</span>
    <span class="hl com">/**</span>
<span class="hl com">     * BotViewer::save-preferences</span>
<span class="hl com">     * &#64;keyfile: a GKeyFile* to be used for saving preferences</span>
<span class="hl com">     *</span>
<span class="hl com">     * The save-preferences signal is emitted when bot_viewer_save_preferences is</span>
<span class="hl com">     * called on the viewer.  Objects can subscribe to this signal to save data</span>
<span class="hl com">     * to the GKeyFile.</span>
<span class="hl com">     */</span>
    bot_viewer_signals<span class="hl opt">[</span>SAVE_PREFERENCES_SIGNAL<span class="hl opt">] =</span> <span class="hl kwd">g_signal_new</span><span class="hl opt">(</span><span class="hl str">&quot;save-preferences&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_TYPE_FROM_CLASS</span><span class="hl opt">(</span>klass<span class="hl opt">),</span>
            G_SIGNAL_RUN_FIRST<span class="hl opt">,</span>
            <span class="hl num">0</span><span class="hl opt">,</span> NULL<span class="hl opt">,</span> NULL<span class="hl opt">,</span> g_cclosure_marshal_VOID__POINTER<span class="hl opt">,</span>
            G_TYPE_NONE<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> G_TYPE_POINTER<span class="hl opt">);</span>
    <span class="hl com">/**</span>
<span class="hl com">     * BotViewer::render-begin</span>
<span class="hl com">     *</span>
<span class="hl com">     * The render-begin signal is emitted during every render cycle, immediately</span>
<span class="hl com">     * before the draw method is invoked on the first enabled renderer.  It is</span>
<span class="hl com">     * emitted after the view handler update method is called.</span>
<span class="hl com">     */</span>
    bot_viewer_signals<span class="hl opt">[</span>RENDER_BEGIN_SIGNAL<span class="hl opt">] =</span> <span class="hl kwd">g_signal_new</span><span class="hl opt">(</span><span class="hl str">&quot;render-begin&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_TYPE_FROM_CLASS</span><span class="hl opt">(</span>klass<span class="hl opt">),</span>
            G_SIGNAL_RUN_FIRST<span class="hl opt">,</span>
            <span class="hl num">0</span><span class="hl opt">,</span> NULL<span class="hl opt">,</span> NULL<span class="hl opt">,</span> g_cclosure_marshal_VOID__VOID<span class="hl opt">,</span>
            G_TYPE_NONE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl com">/**</span>
<span class="hl com">     * BotViewer::render-end</span>
<span class="hl com">     *</span>
<span class="hl com">     * The render-end signal is emitted during every render cycle, after all</span>
<span class="hl com">     * enabled renderers have been invoked.</span>
<span class="hl com">     */</span>
    bot_viewer_signals<span class="hl opt">[</span>RENDER_END_SIGNAL<span class="hl opt">] =</span> <span class="hl kwd">g_signal_new</span><span class="hl opt">(</span><span class="hl str">&quot;render-end&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_TYPE_FROM_CLASS</span><span class="hl opt">(</span>klass<span class="hl opt">),</span>
            G_SIGNAL_RUN_FIRST<span class="hl opt">,</span>
            <span class="hl num">0</span><span class="hl opt">,</span> NULL<span class="hl opt">,</span> NULL<span class="hl opt">,</span> g_cclosure_marshal_VOID__VOID<span class="hl opt">,</span>
            G_TYPE_NONE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>

    <span class="hl kwd">g_type_class_add_private</span> <span class="hl opt">(</span>gobject_class<span class="hl opt">,</span> <span class="hl kwa">sizeof</span> <span class="hl opt">(</span>BotViewerPriv<span class="hl opt">));</span>
<span class="hl opt">}</span>

<span class="hl kwb">static void</span>
<span class="hl kwd">bot_viewer_init</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewerPriv<span class="hl opt">*</span> priv <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER_GET_PRIVATE</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>renderers <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_new</span><span class="hl opt">();</span>
    viewer<span class="hl opt">-&gt;</span>renderers_sorted <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_new</span><span class="hl opt">();</span>
    viewer<span class="hl opt">-&gt;</span>renderers_sorted_with_controls <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_new</span><span class="hl opt">();</span>
    viewer<span class="hl opt">-&gt;</span>event_handlers <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_new</span><span class="hl opt">();</span>
    viewer<span class="hl opt">-&gt;</span>event_handlers_sorted <span class="hl opt">=</span> <span class="hl kwd">g_ptr_array_new</span><span class="hl opt">();</span>

    <span class="hl slc">// default to a white background</span>
    viewer<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> <span class="hl num">1</span><span class="hl opt">;</span>
    viewer<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] =</span> <span class="hl num">1</span><span class="hl opt">;</span>
    viewer<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] =</span> <span class="hl num">1</span><span class="hl opt">;</span>
    viewer<span class="hl opt">-&gt;</span>backgroundColor<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">] =</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl slc">// allocate memory for saved bookmarks</span>
    priv<span class="hl opt">-&gt;</span>num_bookmarks <span class="hl opt">=</span> <span class="hl num">6</span><span class="hl opt">;</span>
    priv<span class="hl opt">-&gt;</span>bookmarks <span class="hl opt">= (</span>bookmark_persp_t<span class="hl opt">*)</span> <span class="hl kwd">calloc</span><span class="hl opt">(</span>priv<span class="hl opt">-&gt;</span>num_bookmarks<span class="hl opt">,</span> 
            <span class="hl kwa">sizeof</span><span class="hl opt">(</span>bookmark_persp_t<span class="hl opt">));</span>
    <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwb">int</span> bk_ind<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> bk_ind<span class="hl opt">&lt;</span>priv<span class="hl opt">-&gt;</span>num_bookmarks<span class="hl opt">;</span> bk_ind<span class="hl opt">++) {</span>
        priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bk_ind<span class="hl opt">].</span>viewer <span class="hl opt">=</span> viewer<span class="hl opt">;</span>
        priv<span class="hl opt">-&gt;</span>bookmarks<span class="hl opt">[</span>bk_ind<span class="hl opt">].</span>index <span class="hl opt">=</span> bk_ind <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl slc">//default views</span>
        <span class="hl slc">//for (int i=0; i&lt;3; i++) {</span>
        <span class="hl slc">//  priv-&gt;bookmarks[bk_ind].eye[i] = *(defaultbmview_eye+i);</span>
        <span class="hl slc">//  priv-&gt;bookmarks[bk_ind].lookat[i] = *(defaultbmview_lookat+i);</span>
        <span class="hl slc">//  priv-&gt;bookmarks[bk_ind].up[i] = *(defaultbmview_up+i);</span>
        <span class="hl slc">// }</span>
    <span class="hl opt">}</span>

    viewer<span class="hl opt">-&gt;</span>prettier_flag <span class="hl opt">= (</span><span class="hl kwd">getenv</span><span class="hl opt">(</span><span class="hl str">&quot;BOT_VIEWER_PRETTIER&quot;</span><span class="hl opt">) !=</span> NULL <span class="hl opt">&amp;&amp;</span> 
                             <span class="hl kwd">atoi</span><span class="hl opt">(</span><span class="hl kwd">getenv</span><span class="hl opt">(</span><span class="hl str">&quot;BOT_VIEWER_PRETTIER&quot;</span><span class="hl opt">))&gt;</span><span class="hl num">0</span><span class="hl opt">);;</span>
    <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;BOT_VIEWER_PRETTIER: %d</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> viewer<span class="hl opt">-&gt;</span>prettier_flag<span class="hl opt">);</span>

    <span class="hl slc">// viewer main window</span>
    viewer<span class="hl opt">-&gt;</span>window <span class="hl opt">=</span> <span class="hl kwd">gtk_window_new</span><span class="hl opt">(</span>GTK_WINDOW_TOPLEVEL<span class="hl opt">);</span>
    <span class="hl kwd">gtk_window_set_title</span><span class="hl opt">(</span><span class="hl kwd">GTK_WINDOW</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl str">&quot;BotViewer&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_window_set_resizable</span><span class="hl opt">(</span><span class="hl kwd">GTK_WINDOW</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> TRUE<span class="hl opt">);</span>
<span class="hl ppc">#ifdef CONTROLS_BOX_LEFT_ENABLED</span>
    <span class="hl kwd">gtk_window_set_default_size</span><span class="hl opt">(</span><span class="hl kwd">GTK_WINDOW</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl num">1000</span><span class="hl opt">,</span> <span class="hl num">675</span><span class="hl opt">);</span>
<span class="hl ppc">#else</span>
    <span class="hl kwd">gtk_window_set_default_size</span><span class="hl opt">(</span><span class="hl kwd">GTK_WINDOW</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl num">800</span><span class="hl opt">,</span> <span class="hl num">540</span><span class="hl opt">);</span>
<span class="hl ppc">#endif</span>

    GtkWidget <span class="hl opt">*</span>vbox <span class="hl opt">=</span> <span class="hl kwd">gtk_vbox_new</span><span class="hl opt">(</span>FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_container_add</span><span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> vbox<span class="hl opt">);</span>

    <span class="hl slc">// keyboard accelerators for viewer</span>
    priv<span class="hl opt">-&gt;</span>key_accel_group <span class="hl opt">=</span> <span class="hl kwd">gtk_accel_group_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_window_add_accel_group</span><span class="hl opt">(</span><span class="hl kwd">GTK_WINDOW</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> priv<span class="hl opt">-&gt;</span>key_accel_group<span class="hl opt">);</span>

    <span class="hl kwd">make_menus</span><span class="hl opt">(</span>viewer<span class="hl opt">,</span> vbox<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>tips <span class="hl opt">=</span> <span class="hl kwd">gtk_tooltips_new</span> <span class="hl opt">();</span>
    <span class="hl kwd">make_toolbar</span><span class="hl opt">(</span>viewer<span class="hl opt">,</span> vbox<span class="hl opt">);</span>


<span class="hl ppc">#ifdef CONTROLS_BOX_LEFT_ENABLED</span>
    <span class="hl slc">// Embed the original viewing pane inside a second hpaned so as to add controls on the right:</span>
    <span class="hl slc">// GTK pan is then split like this:  [   left ctrl box        |[    gl pan  |right ctrl box]]</span>
    GtkWidget <span class="hl opt">*</span>hpaned_main <span class="hl opt">=</span> <span class="hl kwd">gtk_hpaned_new</span><span class="hl opt">();</span>

    <span class="hl slc">// Newer control box on the left:</span>
    GtkWidget <span class="hl opt">*</span>controls_align1 <span class="hl opt">=</span> <span class="hl kwd">gtk_alignment_new</span><span class="hl opt">(</span><span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_paned_pack1</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned_main<span class="hl opt">),</span> controls_align1<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> TRUE<span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span>controls_scroll1 <span class="hl opt">=</span> <span class="hl kwd">gtk_scrolled_window_new</span><span class="hl opt">(</span>NULL<span class="hl opt">,</span> NULL<span class="hl opt">);</span>
    <span class="hl kwd">gtk_container_add</span><span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span><span class="hl opt">(</span>controls_align1<span class="hl opt">),</span> controls_scroll1<span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span>controls_view1 <span class="hl opt">=</span> <span class="hl kwd">gtk_viewport_new</span><span class="hl opt">(</span>NULL<span class="hl opt">,</span> NULL<span class="hl opt">);</span>
    <span class="hl kwd">gtk_container_add</span><span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span><span class="hl opt">(</span>controls_scroll1<span class="hl opt">),</span> controls_view1<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>controls_box_left <span class="hl opt">=</span> <span class="hl kwd">gtk_vbox_new</span><span class="hl opt">(</span>FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_container_add</span><span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span><span class="hl opt">(</span>controls_view1<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>controls_box_left<span class="hl opt">);</span>

    <span class="hl slc">// Original hpan on the right:</span>
    GtkWidget <span class="hl opt">*</span>hpaned_right <span class="hl opt">=</span> <span class="hl kwd">gtk_hpaned_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_paned_pack2</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned_main<span class="hl opt">),</span> hpaned_right<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> TRUE<span class="hl opt">);</span>

    <span class="hl slc">// within original put GL pan on left:</span>
    GtkWidget <span class="hl opt">*</span>gl_box <span class="hl opt">=</span> <span class="hl kwd">gtk_event_box_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_paned_pack1</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned_right<span class="hl opt">),</span> gl_box<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> TRUE<span class="hl opt">);</span>

    <span class="hl slc">// and older controls on the right:</span>
    GtkWidget <span class="hl opt">*</span>controls_align <span class="hl opt">=</span> <span class="hl kwd">gtk_alignment_new</span><span class="hl opt">(</span><span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_paned_pack2</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned_right<span class="hl opt">),</span> controls_align<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> TRUE<span class="hl opt">);</span>

    <span class="hl kwd">gtk_paned_set_position</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned_main<span class="hl opt">),</span> <span class="hl num">200</span><span class="hl opt">);</span> <span class="hl slc">// initial width of bar</span>
    <span class="hl kwd">gtk_paned_set_position</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned_right<span class="hl opt">),</span> <span class="hl num">460</span><span class="hl opt">);</span> <span class="hl slc">// initial width of bar</span>

    <span class="hl kwd">gtk_box_pack_start</span><span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span><span class="hl opt">(</span>vbox<span class="hl opt">),</span> hpaned_main<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>


<span class="hl ppc">#else</span>

    GtkWidget <span class="hl opt">*</span>hpaned <span class="hl opt">=</span> <span class="hl kwd">gtk_hpaned_new</span><span class="hl opt">();</span>

    <span class="hl kwd">gtk_box_pack_start</span><span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span><span class="hl opt">(</span>vbox<span class="hl opt">),</span> hpaned<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span>gl_box <span class="hl opt">=</span> <span class="hl kwd">gtk_event_box_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_paned_pack1</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned<span class="hl opt">),</span> gl_box<span class="hl opt">,</span> TRUE<span class="hl opt">,</span> TRUE<span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span>controls_align <span class="hl opt">=</span> <span class="hl kwd">gtk_alignment_new</span><span class="hl opt">(</span><span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">.5</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_paned_pack2</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned<span class="hl opt">),</span> controls_align<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> TRUE<span class="hl opt">);</span>

    <span class="hl kwd">gtk_paned_set_position</span><span class="hl opt">(</span><span class="hl kwd">GTK_PANED</span><span class="hl opt">(</span>hpaned<span class="hl opt">),</span> <span class="hl num">560</span><span class="hl opt">);</span>

<span class="hl ppc">#endif</span>

    GtkWidget <span class="hl opt">*</span>controls_scroll <span class="hl opt">=</span> <span class="hl kwd">gtk_scrolled_window_new</span><span class="hl opt">(</span>NULL<span class="hl opt">,</span> NULL<span class="hl opt">);</span>
    <span class="hl kwd">gtk_container_add</span><span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span><span class="hl opt">(</span>controls_align<span class="hl opt">),</span> controls_scroll<span class="hl opt">);</span>

    GtkWidget <span class="hl opt">*</span>controls_view <span class="hl opt">=</span> <span class="hl kwd">gtk_viewport_new</span><span class="hl opt">(</span>NULL<span class="hl opt">,</span> NULL<span class="hl opt">);</span>
    <span class="hl kwd">gtk_container_add</span><span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span><span class="hl opt">(</span>controls_scroll<span class="hl opt">),</span> controls_view<span class="hl opt">);</span>

    viewer<span class="hl opt">-&gt;</span>controls_box <span class="hl opt">=</span> <span class="hl kwd">gtk_vbox_new</span><span class="hl opt">(</span>FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_container_add</span><span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span><span class="hl opt">(</span>controls_view<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>controls_box<span class="hl opt">);</span>




    viewer<span class="hl opt">-&gt;</span>status_bar <span class="hl opt">=</span> <span class="hl kwd">gtk_statusbar_new</span><span class="hl opt">();</span>
    <span class="hl kwd">gtk_box_pack_start</span><span class="hl opt">(</span><span class="hl kwd">GTK_BOX</span><span class="hl opt">(</span>vbox<span class="hl opt">),</span> viewer<span class="hl opt">-&gt;</span>status_bar<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> FALSE<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>

    <span class="hl kwd">bot_viewer_set_status_bar_message</span><span class="hl opt">(</span>viewer<span class="hl opt">,</span> <span class="hl str">&quot;Ready&quot;</span><span class="hl opt">);</span>

    <span class="hl slc">// create the aspect area to maintain a 1:1 aspect ratio</span>
    viewer<span class="hl opt">-&gt;</span>gl_area <span class="hl opt">=</span> <span class="hl kwd">BOT_GTK_GL_DRAWING_AREA</span> <span class="hl opt">(</span><span class="hl kwd">bot_gtk_gl_drawing_area_new</span> <span class="hl opt">(</span>FALSE<span class="hl opt">));</span>
    <span class="hl kwd">gtk_widget_set_events</span> <span class="hl opt">(</span><span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">),</span> 
            GDK_LEAVE_NOTIFY_MASK <span class="hl opt">|</span>
            GDK_BUTTON_PRESS_MASK <span class="hl opt">|</span> 
            GDK_BUTTON_RELEASE_MASK <span class="hl opt">|</span> 
            GDK_POINTER_MOTION_MASK<span class="hl opt">);</span>

    <span class="hl kwd">gtk_container_add</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CONTAINER</span> <span class="hl opt">(</span>gl_box<span class="hl opt">),</span> <span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">));</span>

    <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span><span class="hl kwd">GTK_WIDGET</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">));</span>

    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">),</span> <span class="hl str">&quot;configure-event&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_gl_configure<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">),</span> <span class="hl str">&quot;expose-event&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_gl_expose<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">),</span> <span class="hl str">&quot;button-press-event&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_button_press<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">),</span> <span class="hl str">&quot;button-release-event&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_button_release<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">),</span> <span class="hl str">&quot;motion-notify-event&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_motion_notify<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>gl_area<span class="hl opt">),</span> <span class="hl str">&quot;scroll-event&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_scroll_notify<span class="hl opt">),</span> viewer<span class="hl opt">);</span>

    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl str">&quot;key_press_event&quot;</span><span class="hl opt">,</span>
		      <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_main_window_key_press_event<span class="hl opt">),</span> viewer<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl str">&quot;key_release_event&quot;</span><span class="hl opt">,</span>
		      <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>on_main_window_key_release_event<span class="hl opt">),</span> viewer<span class="hl opt">);</span>

    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl str">&quot;delete_event&quot;</span><span class="hl opt">,</span>
		      <span class="hl kwd">G_CALLBACK</span><span class="hl opt">(</span>gtk_main_quit<span class="hl opt">),</span> NULL<span class="hl opt">);</span>
    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl str">&quot;delete_event&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">G_CALLBACK</span> <span class="hl opt">(</span>gtk_widget_hide_on_delete<span class="hl opt">),</span> NULL<span class="hl opt">);</span>

    <span class="hl kwd">g_signal_connect</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> <span class="hl str">&quot;destroy_event&quot;</span><span class="hl opt">,</span>
		      <span class="hl kwd">G_CALLBACK</span><span class="hl opt">(</span>gtk_main_quit<span class="hl opt">),</span> NULL<span class="hl opt">);</span>

    <span class="hl slc">////////////////////////////////////////////////////////////////////</span>
    <span class="hl slc">// Create plugins menu</span>


    <span class="hl slc">// plugins will be inserted here as add_plugin is called</span>
 
    <span class="hl kwd">gtk_widget_show_all</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">);</span>

    BotDefaultViewHandler <span class="hl opt">*</span>dvh <span class="hl opt">=</span> <span class="hl kwd">bot_default_view_handler_new</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>
    viewer<span class="hl opt">-&gt;</span>default_view_handler <span class="hl opt">= &amp;</span>dvh<span class="hl opt">-&gt;</span>vhandler<span class="hl opt">;</span>

    <span class="hl kwd">bot_viewer_request_redraw</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>
<span class="hl opt">}</span>

BotViewer <span class="hl opt">*</span><span class="hl kwd">bot_viewer_new</span> <span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>window_title<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotViewer <span class="hl opt">*</span>viewer <span class="hl opt">=</span> <span class="hl kwd">BOT_VIEWER</span> <span class="hl opt">(</span><span class="hl kwd">g_object_new</span> <span class="hl opt">(</span>TYPE_BOT_VIEWER<span class="hl opt">,</span> NULL<span class="hl opt">));</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>viewer<span class="hl opt">!=</span>NULL<span class="hl opt">)</span>
      <span class="hl kwd">bot_viewer_set_window_title</span> <span class="hl opt">(</span>viewer<span class="hl opt">,</span> window_title<span class="hl opt">);</span>
    <span class="hl kwa">return</span> viewer<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_unref</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwd">g_object_unref</span> <span class="hl opt">(</span>viewer<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_set_window_title</span> <span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> <span class="hl kwb">const char</span> <span class="hl opt">*</span>window_title<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwd">gtk_window_set_title</span><span class="hl opt">(</span><span class="hl kwd">GTK_WINDOW</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>window<span class="hl opt">),</span> window_title<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_set_view_handler</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> BotViewHandler <span class="hl opt">*</span>vhandler<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>vhandler<span class="hl opt">) {</span>
        viewer<span class="hl opt">-&gt;</span>view_handler <span class="hl opt">=</span> vhandler<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        viewer<span class="hl opt">-&gt;</span>view_handler <span class="hl opt">=</span> viewer<span class="hl opt">-&gt;</span>default_view_handler<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl slc">// sort in decending order of priority</span>
<span class="hl kwb">static</span> gint <span class="hl kwd">sort_ehandler_priority_decreasing</span><span class="hl opt">(</span>gconstpointer _a<span class="hl opt">,</span> gconstpointer _b<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotEventHandler <span class="hl opt">*</span>a <span class="hl opt">= *(</span>BotEventHandler<span class="hl opt">**)</span> _a<span class="hl opt">;</span>
    BotEventHandler <span class="hl opt">*</span>b <span class="hl opt">= *(</span>BotEventHandler<span class="hl opt">**)</span> _b<span class="hl opt">;</span>

    <span class="hl kwa">return</span> <span class="hl opt">(</span>a<span class="hl opt">-&gt;</span>priority <span class="hl opt">&lt;</span> b<span class="hl opt">-&gt;</span>priority<span class="hl opt">)</span> ? <span class="hl num">1</span> <span class="hl opt">: -</span><span class="hl num">1</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl slc">// sort in decending order of priority</span>
<span class="hl kwb">static</span> gint <span class="hl kwd">sort_ehandler_alphabetical</span><span class="hl opt">(</span>gconstpointer _a<span class="hl opt">,</span> gconstpointer _b<span class="hl opt">)</span>
<span class="hl opt">{</span>
    BotEventHandler <span class="hl opt">*</span>a <span class="hl opt">= *(</span>BotEventHandler<span class="hl opt">**)</span> _a<span class="hl opt">;</span>
    BotEventHandler <span class="hl opt">*</span>b <span class="hl opt">= *(</span>BotEventHandler<span class="hl opt">**)</span> _b<span class="hl opt">;</span>

    <span class="hl kwa">return</span> <span class="hl kwd">strcmp</span><span class="hl opt">(</span>a<span class="hl opt">-&gt;</span>name<span class="hl opt">,</span> b<span class="hl opt">-&gt;</span>name<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_add_event_handler</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> BotEventHandler <span class="hl opt">*</span>ehandler<span class="hl opt">,</span> <span class="hl kwb">int</span> priority<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwd">g_ptr_array_add</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> ehandler<span class="hl opt">);</span>
    <span class="hl kwd">bot_viewer_event_handler_set_priority</span><span class="hl opt">(</span>viewer<span class="hl opt">,</span> ehandler<span class="hl opt">,</span> priority<span class="hl opt">);</span>

    <span class="hl kwd">g_ptr_array_add</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_sorted<span class="hl opt">,</span> ehandler<span class="hl opt">);</span>
    <span class="hl kwd">g_ptr_array_sort</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_sorted<span class="hl opt">,</span> sort_ehandler_alphabetical<span class="hl opt">);</span>

    ehandler<span class="hl opt">-&gt;</span>cmi <span class="hl opt">=</span> <span class="hl kwd">gtk_check_menu_item_new_with_label</span><span class="hl opt">(</span>ehandler<span class="hl opt">-&gt;</span>name<span class="hl opt">);</span>
    <span class="hl kwd">g_object_set_data</span> <span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span> <span class="hl opt">(</span>ehandler<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> <span class="hl str">&quot;BotViewer:plugin&quot;</span><span class="hl opt">,</span> ehandler<span class="hl opt">);</span>
    <span class="hl kwd">gtk_check_menu_item_set_active</span> <span class="hl opt">(</span><span class="hl kwd">GTK_CHECK_MENU_ITEM</span> <span class="hl opt">(</span>ehandler<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> ehandler<span class="hl opt">-&gt;</span>enabled<span class="hl opt">);</span>

    <span class="hl kwd">g_signal_connect</span><span class="hl opt">(</span><span class="hl kwd">G_OBJECT</span><span class="hl opt">(</span>ehandler<span class="hl opt">-&gt;</span>cmi<span class="hl opt">),</span> <span class="hl str">&quot;toggled&quot;</span><span class="hl opt">,</span>
                     <span class="hl kwd">G_CALLBACK</span><span class="hl opt">(</span>on_event_handler_enabled_toggled<span class="hl opt">),</span> viewer<span class="hl opt">);</span>

    <span class="hl slc">// What position in the sorted array is this item?</span>
    <span class="hl kwb">unsigned int</span> menu_idx <span class="hl opt">=</span> <span class="hl kwd">_g_ptr_array_find_index</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_sorted<span class="hl opt">,</span> ehandler<span class="hl opt">);</span>

    <span class="hl slc">// add the menu item, accounting for the tear-off tab at index 0</span>
    <span class="hl kwd">gtk_menu_shell_insert</span> <span class="hl opt">(</span><span class="hl kwd">GTK_MENU_SHELL</span> <span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers_menu<span class="hl opt">),</span> ehandler<span class="hl opt">-&gt;</span>cmi<span class="hl opt">,</span> menu_idx <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">gtk_widget_show</span> <span class="hl opt">(</span>ehandler<span class="hl opt">-&gt;</span>cmi<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_event_handler_set_priority</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> BotEventHandler <span class="hl opt">*</span>ehandler<span class="hl opt">,</span> <span class="hl kwb">int</span> priority<span class="hl opt">)</span>
<span class="hl opt">{</span>
    ehandler<span class="hl opt">-&gt;</span>priority <span class="hl opt">=</span> priority<span class="hl opt">;</span>
    <span class="hl kwd">g_ptr_array_sort</span><span class="hl opt">(</span>viewer<span class="hl opt">-&gt;</span>event_handlers<span class="hl opt">,</span> sort_ehandler_priority_decreasing<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwb">int</span> <span class="hl kwd">bot_viewer_picking</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">return</span> viewer<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">&amp;&amp;</span> viewer<span class="hl opt">-&gt;</span>picking_handler<span class="hl opt">-&gt;</span>picking<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">int</span> <span class="hl kwd">bot_viewer_request_pick</span><span class="hl opt">(</span>BotViewer <span class="hl opt">*</span>viewer<span class="hl opt">,</span> BotEventHandler <span class="hl opt">*</span>ehandler<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">bot_viewer_picking</span><span class="hl opt">(</span>viewer<span class="hl opt">) &amp;&amp;</span> viewer<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">!=</span> ehandler<span class="hl opt">)</span>
        <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">;</span>

    ehandler<span class="hl opt">-&gt;</span>picking <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    viewer<span class="hl opt">-&gt;</span>picking_handler <span class="hl opt">=</span> ehandler<span class="hl opt">;</span>
    <span class="hl kwd">update_status_bar</span><span class="hl opt">(</span>viewer<span class="hl opt">);</span>
    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">bot_viewer_add_stock_renderer_grid</span><span class="hl opt">(</span>BotViewer<span class="hl opt">*</span> viewer<span class="hl opt">,</span> <span class="hl kwb">int</span> priority<span class="hl opt">);</span>

<span class="hl kwb">void</span> 
<span class="hl kwd">bot_viewer_add_stock_renderer</span><span class="hl opt">(</span>BotViewer<span class="hl opt">*</span> viewer<span class="hl opt">,</span> <span class="hl kwb">int</span> stock_renderer_id<span class="hl opt">,</span> <span class="hl kwb">int</span> priority<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">switch</span><span class="hl opt">(</span>stock_renderer_id<span class="hl opt">) {</span>
        <span class="hl kwa">case</span> BOT_VIEWER_STOCK_RENDERER_GRID<span class="hl opt">:</span>
            <span class="hl kwd">bot_viewer_add_stock_renderer_grid</span><span class="hl opt">(</span>viewer<span class="hl opt">,</span> priority<span class="hl opt">);</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl kwa">default</span><span class="hl opt">:</span>
            <span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;%s: Unrecognized stock renderer id %d.</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> __FUNCTION__<span class="hl opt">,</span> stock_renderer_id<span class="hl opt">);</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.27, http://www.andre-simon.de/-->
